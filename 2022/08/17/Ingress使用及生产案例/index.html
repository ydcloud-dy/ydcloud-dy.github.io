<!DOCTYPE html><html lang="zh-CN" data-theme="dark"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"><title>Ingress使用及生产案例 | J.のblog</title><meta name="keywords" content="kubernetes,云原生"><meta name="author" content="J."><meta name="copyright" content="J."><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#0d0d0d"><meta name="description" content="ingress一、ingress架构Ingress Controller nginx，k8s官方维护的 生产级架构图  1. 外部接入层（Internet&#x2F;DMZ） 功能：接收来自互联网的HTTP&#x2F;HTTPS请求，提供安全隔离（DMZ区）。 关键组件： 企业级负载均衡设备：如F5、LVS、HAProxy等[1][2]，用于SSL终止和请求分发。 端口暴露：开放80（HTTP）和">
<meta property="og:type" content="article">
<meta property="og:title" content="Ingress使用及生产案例">
<meta property="og:url" content="http://dycloud.fun/2022/08/17/Ingress%E4%BD%BF%E7%94%A8%E5%8F%8A%E7%94%9F%E4%BA%A7%E6%A1%88%E4%BE%8B/index.html">
<meta property="og:site_name" content="J.のblog">
<meta property="og:description" content="ingress一、ingress架构Ingress Controller nginx，k8s官方维护的 生产级架构图  1. 外部接入层（Internet&#x2F;DMZ） 功能：接收来自互联网的HTTP&#x2F;HTTPS请求，提供安全隔离（DMZ区）。 关键组件： 企业级负载均衡设备：如F5、LVS、HAProxy等[1][2]，用于SSL终止和请求分发。 端口暴露：开放80（HTTP）和">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="http://dycloud.fun/img/kubernetes.png">
<meta property="article:published_time" content="2022-08-17T08:21:00.000Z">
<meta property="article:modified_time" content="2025-03-27T08:08:22.661Z">
<meta property="article:author" content="J.">
<meta property="article:tag" content="kubernetes">
<meta property="article:tag" content="云原生">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://dycloud.fun/img/kubernetes.png"><link rel="shortcut icon" href="/img/touxiang.png"><link rel="canonical" href="http://dycloud.fun/2022/08/17/Ingress%E4%BD%BF%E7%94%A8%E5%8F%8A%E7%94%9F%E4%BA%A7%E6%A1%88%E4%BE%8B/"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox.min.css" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = { 
  root: '/',
  algolia: {"appId":"9GWB2VV7GN","apiKey":"dac56ec5b0b1f45281251ee59db4d637","indexName":"blog","hits":{"per_page":6},"languages":{"input_placeholder":"搜索文章","hits_empty":"找不到您查询的内容：${query}","hits_stats":"找到 ${hits} 条结果，用时 ${time} 毫秒"}},
  localSearch: undefined,
  translate: {"defaultEncoding":2,"translateDelay":0,"msgToTraditionalChinese":"繁","msgToSimplifiedChinese":"簡"},
  noticeOutdate: undefined,
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '天',
  date_suffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: undefined,
  lightbox: 'fancybox',
  Snackbar: undefined,
  source: {
    justifiedGallery: {
      js: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery/dist/fjGallery.min.js',
      css: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery/dist/fjGallery.min.css'
    }
  },
  isPhotoFigcaption: false,
  islazyload: false,
  isAnchor: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'Ingress使用及生产案例',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2025-03-27 16:08:22'
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(win=>{
    win.saveToLocal = {
      set: function setWithExpiry(key, value, ttl) {
        if (ttl === 0) return
        const now = new Date()
        const expiryDay = ttl * 86400000
        const item = {
          value: value,
          expiry: now.getTime() + expiryDay,
        }
        localStorage.setItem(key, JSON.stringify(item))
      },

      get: function getWithExpiry(key) {
        const itemStr = localStorage.getItem(key)

        if (!itemStr) {
          return undefined
        }
        const item = JSON.parse(itemStr)
        const now = new Date()

        if (now.getTime() > item.expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return item.value
      }
    }
  
    win.getScript = url => new Promise((resolve, reject) => {
      const script = document.createElement('script')
      script.src = url
      script.async = true
      script.onerror = reject
      script.onload = script.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        script.onload = script.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(script)
    })
  
      win.activateDarkMode = function () {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = function () {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
          if (t === 'dark') activateDarkMode()
          else if (t === 'light') activateLightMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
    const detectApple = () => {
      if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
    })(window)</script><link rel="stylesheet" href="/xxx.css"><link rel="stylesheet" href="/css/universe.css"><link rel="stylesheet" href="/css/custom.css"><style type="text/css">#toggle-sidebar {bottom: 80px}</style><link rel="stylesheet" href="https://fastly.jsdelivr.net/gh/tzy13755126023/BLOG_SOURCE/css/function.min.css"><link rel="stylesheet" href="/css/rightMenu.css"><style type="text/css">#toggle-sidebar {left:100px}</style><!-- hexo injector head_end start --><link rel="stylesheet" href="https://cdn.cbd.int/hexo-butterfly-clock-anzhiyu/lib/clock.min.css" /><!-- hexo injector head_end end --><meta name="generator" content="Hexo 6.2.0"><link rel="alternate" href="/atom.xml" title="J.のblog" type="application/atom+xml">
</head><body><div id="loading-box"><div class="loading-left-bg"></div><div class="loading-right-bg"></div><div class="spinner-box"><div class="configure-border-1"><div class="configure-core"></div></div><div class="configure-border-2"><div class="configure-core"></div></div><div class="loading-word">加载中...</div></div></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src="/img/touxiang.png" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="sidebar-site-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">137</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">20</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">14</div></a></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 归档</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url('/img/longzhu.png')"><nav id="nav"><span id="blog_name"><a id="site-name" href="/">J.のblog</a></span><div id="menus"><div id="search-button"><a class="site-page social-icon search"><i class="fas fa-search fa-fw"></i><span> 搜索</span></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 归档</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div></div><div id="toggle-menu"><a class="site-page"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">Ingress使用及生产案例</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2022-08-17T08:21:00.000Z" title="发表于 2022-08-17 16:21:00">2022-08-17</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2025-03-27T08:08:22.661Z" title="更新于 2025-03-27 16:08:22">2025-03-27</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/kubernetes/">kubernetes</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title="Ingress使用及生产案例"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">阅读量:</span><span id="busuanzi_value_page_pv"><i class="fa-solid fa-spinner fa-spin"></i></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><h1 id="ingress"><a href="#ingress" class="headerlink" title="ingress"></a>ingress</h1><h3 id="一、ingress架构"><a href="#一、ingress架构" class="headerlink" title="一、ingress架构"></a>一、ingress架构</h3><p>Ingress Controller nginx，k8s官方维护的</p>
<p>生产级架构图</p>
<p><img src="/images/s5POAWPlob_miRoUYiTl3esudx-vhmZ4hWum_dhzmSA.png" alt="image"></p>
<h6 id="1-外部接入层（Internet-x2F-DMZ）"><a href="#1-外部接入层（Internet-x2F-DMZ）" class="headerlink" title="1. 外部接入层（Internet&#x2F;DMZ）"></a><strong>1. 外部接入层（Internet&#x2F;DMZ）</strong></h6><ul>
<li><strong>功能</strong>：接收来自互联网的HTTP&#x2F;HTTPS请求，提供安全隔离（DMZ区）。</li>
<li><strong>关键组件</strong>：<ul>
<li><strong>企业级负载均衡设备</strong>：如F5、LVS、HAProxy等[1][2]，用于SSL终止和请求分发。</li>
<li><strong>端口暴露</strong>：开放80（HTTP）和443（HTTPS）端口，作为入口端口。</li>
</ul>
</li>
</ul>
<h6 id="2-负载均衡层（高可用设计）"><a href="#2-负载均衡层（高可用设计）" class="headerlink" title="2. 负载均衡层（高可用设计）"></a><strong>2. 负载均衡层（高可用设计）</strong></h6><ul>
<li><strong>高可用机制</strong>：<ul>
<li><strong>多实例负载均衡</strong>：部署多个Nginx或HAProxy实例，通过健康检查实现流量动态分配。</li>
</ul>
</li>
<li><strong>流量分发逻辑</strong>：<ul>
<li>将请求均匀分发至后端的<code>Ingress Controller</code>实例（<code>Gateway Node</code>）。</li>
</ul>
</li>
</ul>
<h6 id="3-Ingress控制层（Kubernetes节点）"><a href="#3-Ingress控制层（Kubernetes节点）" class="headerlink" title="3. Ingress控制层（Kubernetes节点）"></a><strong>3. Ingress控制层（Kubernetes节点）</strong></h6><ul>
<li><strong>部署方式</strong>：<ul>
<li><strong>HostNetwork模式</strong>：<code>Ingress Controller Pod</code>直接绑定宿主机网络，跳过<code>Kubernetes Service</code>（如<code>NodePort</code>），降低性能损耗。</li>
<li><strong>多节点部署</strong>：通过<code>Deployment</code>部署多个<code>Controller</code>实例，结合节点亲和性（<code>nodeSelector</code>）和Pod反亲和性（<code>PodAntiAffinity</code>）确保跨节点分布。</li>
</ul>
</li>
<li><strong>动态配置更新</strong>：<ul>
<li><strong>监听K8s资源</strong>：实时监听<code>Ingress</code>、<code>Service</code>、<code>Endpoint</code>等资源变化，自动生成Nginx配置并触发热更新（<code>Reload</code>）。</li>
<li><strong>热更新优化</strong>：采用OpenResty减少Reload性能影响，避免长尾请求中断。</li>
</ul>
</li>
</ul>
<h6 id="4-后端服务层（Real-Server）"><a href="#4-后端服务层（Real-Server）" class="headerlink" title="4. 后端服务层（Real Server）"></a><strong>4. 后端服务层（Real Server）</strong></h6><ul>
<li><p><strong>服务路由</strong>：</p>
<ul>
<li>根据Ingress规则（域名&#x2F;路径）将请求路由至对应的后端<code>Service</code>（如Web应用、API服务）。</li>
</ul>
</li>
<li><p><strong>服务发现</strong>：</p>
<ul>
<li>通过<code>Kubernetes Endpoints</code>动态获取Pod IP，支持扩缩容和故障转移。</li>
</ul>
</li>
</ul>
<p>部署yaml：</p>
<pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Namespace
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">labels</span><span class="token punctuation">:</span>
    <span class="token key atrule">app.kubernetes.io/instance</span><span class="token punctuation">:</span> ingress<span class="token punctuation">-</span>nginx
    <span class="token key atrule">app.kubernetes.io/name</span><span class="token punctuation">:</span> ingress<span class="token punctuation">-</span>nginx
  <span class="token key atrule">name</span><span class="token punctuation">:</span> ingress<span class="token punctuation">-</span>nginx
<span class="token punctuation">---</span>
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">automountServiceAccountToken</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
<span class="token key atrule">kind</span><span class="token punctuation">:</span> ServiceAccount
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">labels</span><span class="token punctuation">:</span>
    <span class="token key atrule">app.kubernetes.io/component</span><span class="token punctuation">:</span> controller
    <span class="token key atrule">app.kubernetes.io/instance</span><span class="token punctuation">:</span> ingress<span class="token punctuation">-</span>nginx
    <span class="token key atrule">app.kubernetes.io/name</span><span class="token punctuation">:</span> ingress<span class="token punctuation">-</span>nginx
    <span class="token key atrule">app.kubernetes.io/part-of</span><span class="token punctuation">:</span> ingress<span class="token punctuation">-</span>nginx
    <span class="token key atrule">app.kubernetes.io/version</span><span class="token punctuation">:</span> 1.7.1
  <span class="token key atrule">name</span><span class="token punctuation">:</span> ingress<span class="token punctuation">-</span>nginx
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> ingress<span class="token punctuation">-</span>nginx
<span class="token punctuation">---</span>
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> ServiceAccount
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">labels</span><span class="token punctuation">:</span>
    <span class="token key atrule">app.kubernetes.io/component</span><span class="token punctuation">:</span> admission<span class="token punctuation">-</span>webhook
    <span class="token key atrule">app.kubernetes.io/instance</span><span class="token punctuation">:</span> ingress<span class="token punctuation">-</span>nginx
    <span class="token key atrule">app.kubernetes.io/name</span><span class="token punctuation">:</span> ingress<span class="token punctuation">-</span>nginx
    <span class="token key atrule">app.kubernetes.io/part-of</span><span class="token punctuation">:</span> ingress<span class="token punctuation">-</span>nginx
    <span class="token key atrule">app.kubernetes.io/version</span><span class="token punctuation">:</span> 1.7.1
  <span class="token key atrule">name</span><span class="token punctuation">:</span> ingress<span class="token punctuation">-</span>nginx<span class="token punctuation">-</span>admission
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> ingress<span class="token punctuation">-</span>nginx
<span class="token punctuation">---</span>
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> rbac.authorization.k8s.io/v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Role
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">labels</span><span class="token punctuation">:</span>
    <span class="token key atrule">app.kubernetes.io/component</span><span class="token punctuation">:</span> controller
    <span class="token key atrule">app.kubernetes.io/instance</span><span class="token punctuation">:</span> ingress<span class="token punctuation">-</span>nginx
    <span class="token key atrule">app.kubernetes.io/name</span><span class="token punctuation">:</span> ingress<span class="token punctuation">-</span>nginx
    <span class="token key atrule">app.kubernetes.io/part-of</span><span class="token punctuation">:</span> ingress<span class="token punctuation">-</span>nginx
    <span class="token key atrule">app.kubernetes.io/version</span><span class="token punctuation">:</span> 1.7.1
  <span class="token key atrule">name</span><span class="token punctuation">:</span> ingress<span class="token punctuation">-</span>nginx
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> ingress<span class="token punctuation">-</span>nginx
<span class="token key atrule">rules</span><span class="token punctuation">:</span>
<span class="token punctuation">-</span> <span class="token key atrule">apiGroups</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token string">""</span>
  <span class="token key atrule">resources</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> namespaces
  <span class="token key atrule">verbs</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> get
<span class="token punctuation">-</span> <span class="token key atrule">apiGroups</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token string">""</span>
  <span class="token key atrule">resources</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> configmaps
  <span class="token punctuation">-</span> pods
  <span class="token punctuation">-</span> secrets
  <span class="token punctuation">-</span> endpoints
  <span class="token key atrule">verbs</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> get
  <span class="token punctuation">-</span> list
  <span class="token punctuation">-</span> watch
<span class="token punctuation">-</span> <span class="token key atrule">apiGroups</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token string">""</span>
  <span class="token key atrule">resources</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> services
  <span class="token key atrule">verbs</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> get
  <span class="token punctuation">-</span> list
  <span class="token punctuation">-</span> watch
<span class="token punctuation">-</span> <span class="token key atrule">apiGroups</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> networking.k8s.io
  <span class="token key atrule">resources</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> ingresses
  <span class="token key atrule">verbs</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> get
  <span class="token punctuation">-</span> list
  <span class="token punctuation">-</span> watch
<span class="token punctuation">-</span> <span class="token key atrule">apiGroups</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> networking.k8s.io
  <span class="token key atrule">resources</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> ingresses/status
  <span class="token key atrule">verbs</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> update
<span class="token punctuation">-</span> <span class="token key atrule">apiGroups</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> networking.k8s.io
  <span class="token key atrule">resources</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> ingressclasses
  <span class="token key atrule">verbs</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> get
  <span class="token punctuation">-</span> list
  <span class="token punctuation">-</span> watch
<span class="token punctuation">-</span> <span class="token key atrule">apiGroups</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> coordination.k8s.io
  <span class="token key atrule">resourceNames</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> ingress<span class="token punctuation">-</span>nginx<span class="token punctuation">-</span>leader
  <span class="token key atrule">resources</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> leases
  <span class="token key atrule">verbs</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> get
  <span class="token punctuation">-</span> update
<span class="token punctuation">-</span> <span class="token key atrule">apiGroups</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> coordination.k8s.io
  <span class="token key atrule">resources</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> leases
  <span class="token key atrule">verbs</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> create
<span class="token punctuation">-</span> <span class="token key atrule">apiGroups</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token string">""</span>
  <span class="token key atrule">resources</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> events
  <span class="token key atrule">verbs</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> create
  <span class="token punctuation">-</span> patch
<span class="token punctuation">-</span> <span class="token key atrule">apiGroups</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> discovery.k8s.io
  <span class="token key atrule">resources</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> endpointslices
  <span class="token key atrule">verbs</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> list
  <span class="token punctuation">-</span> watch
  <span class="token punctuation">-</span> get
<span class="token punctuation">---</span>
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> rbac.authorization.k8s.io/v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Role
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">labels</span><span class="token punctuation">:</span>
    <span class="token key atrule">app.kubernetes.io/component</span><span class="token punctuation">:</span> admission<span class="token punctuation">-</span>webhook
    <span class="token key atrule">app.kubernetes.io/instance</span><span class="token punctuation">:</span> ingress<span class="token punctuation">-</span>nginx
    <span class="token key atrule">app.kubernetes.io/name</span><span class="token punctuation">:</span> ingress<span class="token punctuation">-</span>nginx
    <span class="token key atrule">app.kubernetes.io/part-of</span><span class="token punctuation">:</span> ingress<span class="token punctuation">-</span>nginx
    <span class="token key atrule">app.kubernetes.io/version</span><span class="token punctuation">:</span> 1.7.1
  <span class="token key atrule">name</span><span class="token punctuation">:</span> ingress<span class="token punctuation">-</span>nginx<span class="token punctuation">-</span>admission
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> ingress<span class="token punctuation">-</span>nginx
<span class="token key atrule">rules</span><span class="token punctuation">:</span>
<span class="token punctuation">-</span> <span class="token key atrule">apiGroups</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token string">""</span>
  <span class="token key atrule">resources</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> secrets
  <span class="token key atrule">verbs</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> get
  <span class="token punctuation">-</span> create
<span class="token punctuation">---</span>
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> rbac.authorization.k8s.io/v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> ClusterRole
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">labels</span><span class="token punctuation">:</span>
    <span class="token key atrule">app.kubernetes.io/instance</span><span class="token punctuation">:</span> ingress<span class="token punctuation">-</span>nginx
    <span class="token key atrule">app.kubernetes.io/name</span><span class="token punctuation">:</span> ingress<span class="token punctuation">-</span>nginx
    <span class="token key atrule">app.kubernetes.io/part-of</span><span class="token punctuation">:</span> ingress<span class="token punctuation">-</span>nginx
    <span class="token key atrule">app.kubernetes.io/version</span><span class="token punctuation">:</span> 1.7.1
  <span class="token key atrule">name</span><span class="token punctuation">:</span> ingress<span class="token punctuation">-</span>nginx
<span class="token key atrule">rules</span><span class="token punctuation">:</span>
<span class="token punctuation">-</span> <span class="token key atrule">apiGroups</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token string">""</span>
  <span class="token key atrule">resources</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> configmaps
  <span class="token punctuation">-</span> endpoints
  <span class="token punctuation">-</span> nodes
  <span class="token punctuation">-</span> pods
  <span class="token punctuation">-</span> secrets
  <span class="token punctuation">-</span> namespaces
  <span class="token key atrule">verbs</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> list
  <span class="token punctuation">-</span> watch
<span class="token punctuation">-</span> <span class="token key atrule">apiGroups</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> coordination.k8s.io
  <span class="token key atrule">resources</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> leases
  <span class="token key atrule">verbs</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> list
  <span class="token punctuation">-</span> watch
<span class="token punctuation">-</span> <span class="token key atrule">apiGroups</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token string">""</span>
  <span class="token key atrule">resources</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> nodes
  <span class="token key atrule">verbs</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> get
<span class="token punctuation">-</span> <span class="token key atrule">apiGroups</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token string">""</span>
  <span class="token key atrule">resources</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> services
  <span class="token key atrule">verbs</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> get
  <span class="token punctuation">-</span> list
  <span class="token punctuation">-</span> watch
<span class="token punctuation">-</span> <span class="token key atrule">apiGroups</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> networking.k8s.io
  <span class="token key atrule">resources</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> ingresses
  <span class="token key atrule">verbs</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> get
  <span class="token punctuation">-</span> list
  <span class="token punctuation">-</span> watch
<span class="token punctuation">-</span> <span class="token key atrule">apiGroups</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token string">""</span>
  <span class="token key atrule">resources</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> events
  <span class="token key atrule">verbs</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> create
  <span class="token punctuation">-</span> patch
<span class="token punctuation">-</span> <span class="token key atrule">apiGroups</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> networking.k8s.io
  <span class="token key atrule">resources</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> ingresses/status
  <span class="token key atrule">verbs</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> update
<span class="token punctuation">-</span> <span class="token key atrule">apiGroups</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> networking.k8s.io
  <span class="token key atrule">resources</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> ingressclasses
  <span class="token key atrule">verbs</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> get
  <span class="token punctuation">-</span> list
  <span class="token punctuation">-</span> watch
<span class="token punctuation">-</span> <span class="token key atrule">apiGroups</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> discovery.k8s.io
  <span class="token key atrule">resources</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> endpointslices
  <span class="token key atrule">verbs</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> list
  <span class="token punctuation">-</span> watch
  <span class="token punctuation">-</span> get
<span class="token punctuation">---</span>
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> rbac.authorization.k8s.io/v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> ClusterRole
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">labels</span><span class="token punctuation">:</span>
    <span class="token key atrule">app.kubernetes.io/component</span><span class="token punctuation">:</span> admission<span class="token punctuation">-</span>webhook
    <span class="token key atrule">app.kubernetes.io/instance</span><span class="token punctuation">:</span> ingress<span class="token punctuation">-</span>nginx
    <span class="token key atrule">app.kubernetes.io/name</span><span class="token punctuation">:</span> ingress<span class="token punctuation">-</span>nginx
    <span class="token key atrule">app.kubernetes.io/part-of</span><span class="token punctuation">:</span> ingress<span class="token punctuation">-</span>nginx
    <span class="token key atrule">app.kubernetes.io/version</span><span class="token punctuation">:</span> 1.7.1
  <span class="token key atrule">name</span><span class="token punctuation">:</span> ingress<span class="token punctuation">-</span>nginx<span class="token punctuation">-</span>admission
<span class="token key atrule">rules</span><span class="token punctuation">:</span>
<span class="token punctuation">-</span> <span class="token key atrule">apiGroups</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> admissionregistration.k8s.io
  <span class="token key atrule">resources</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> validatingwebhookconfigurations
  <span class="token key atrule">verbs</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> get
  <span class="token punctuation">-</span> update
<span class="token punctuation">---</span>
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> rbac.authorization.k8s.io/v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> RoleBinding
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">labels</span><span class="token punctuation">:</span>
    <span class="token key atrule">app.kubernetes.io/component</span><span class="token punctuation">:</span> controller
    <span class="token key atrule">app.kubernetes.io/instance</span><span class="token punctuation">:</span> ingress<span class="token punctuation">-</span>nginx
    <span class="token key atrule">app.kubernetes.io/name</span><span class="token punctuation">:</span> ingress<span class="token punctuation">-</span>nginx
    <span class="token key atrule">app.kubernetes.io/part-of</span><span class="token punctuation">:</span> ingress<span class="token punctuation">-</span>nginx
    <span class="token key atrule">app.kubernetes.io/version</span><span class="token punctuation">:</span> 1.7.1
  <span class="token key atrule">name</span><span class="token punctuation">:</span> ingress<span class="token punctuation">-</span>nginx
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> ingress<span class="token punctuation">-</span>nginx
<span class="token key atrule">roleRef</span><span class="token punctuation">:</span>
  <span class="token key atrule">apiGroup</span><span class="token punctuation">:</span> rbac.authorization.k8s.io
  <span class="token key atrule">kind</span><span class="token punctuation">:</span> Role
  <span class="token key atrule">name</span><span class="token punctuation">:</span> ingress<span class="token punctuation">-</span>nginx
<span class="token key atrule">subjects</span><span class="token punctuation">:</span>
<span class="token punctuation">-</span> <span class="token key atrule">kind</span><span class="token punctuation">:</span> ServiceAccount
  <span class="token key atrule">name</span><span class="token punctuation">:</span> ingress<span class="token punctuation">-</span>nginx
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> ingress<span class="token punctuation">-</span>nginx
<span class="token punctuation">---</span>
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> rbac.authorization.k8s.io/v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> RoleBinding
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">labels</span><span class="token punctuation">:</span>
    <span class="token key atrule">app.kubernetes.io/component</span><span class="token punctuation">:</span> admission<span class="token punctuation">-</span>webhook
    <span class="token key atrule">app.kubernetes.io/instance</span><span class="token punctuation">:</span> ingress<span class="token punctuation">-</span>nginx
    <span class="token key atrule">app.kubernetes.io/name</span><span class="token punctuation">:</span> ingress<span class="token punctuation">-</span>nginx
    <span class="token key atrule">app.kubernetes.io/part-of</span><span class="token punctuation">:</span> ingress<span class="token punctuation">-</span>nginx
    <span class="token key atrule">app.kubernetes.io/version</span><span class="token punctuation">:</span> 1.7.1
  <span class="token key atrule">name</span><span class="token punctuation">:</span> ingress<span class="token punctuation">-</span>nginx<span class="token punctuation">-</span>admission
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> ingress<span class="token punctuation">-</span>nginx
<span class="token key atrule">roleRef</span><span class="token punctuation">:</span>
  <span class="token key atrule">apiGroup</span><span class="token punctuation">:</span> rbac.authorization.k8s.io
  <span class="token key atrule">kind</span><span class="token punctuation">:</span> Role
  <span class="token key atrule">name</span><span class="token punctuation">:</span> ingress<span class="token punctuation">-</span>nginx<span class="token punctuation">-</span>admission
<span class="token key atrule">subjects</span><span class="token punctuation">:</span>
<span class="token punctuation">-</span> <span class="token key atrule">kind</span><span class="token punctuation">:</span> ServiceAccount
  <span class="token key atrule">name</span><span class="token punctuation">:</span> ingress<span class="token punctuation">-</span>nginx<span class="token punctuation">-</span>admission
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> ingress<span class="token punctuation">-</span>nginx
<span class="token punctuation">---</span>
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> rbac.authorization.k8s.io/v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> ClusterRoleBinding
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">labels</span><span class="token punctuation">:</span>
    <span class="token key atrule">app.kubernetes.io/instance</span><span class="token punctuation">:</span> ingress<span class="token punctuation">-</span>nginx
    <span class="token key atrule">app.kubernetes.io/name</span><span class="token punctuation">:</span> ingress<span class="token punctuation">-</span>nginx
    <span class="token key atrule">app.kubernetes.io/part-of</span><span class="token punctuation">:</span> ingress<span class="token punctuation">-</span>nginx
    <span class="token key atrule">app.kubernetes.io/version</span><span class="token punctuation">:</span> 1.7.1
  <span class="token key atrule">name</span><span class="token punctuation">:</span> ingress<span class="token punctuation">-</span>nginx
<span class="token key atrule">roleRef</span><span class="token punctuation">:</span>
  <span class="token key atrule">apiGroup</span><span class="token punctuation">:</span> rbac.authorization.k8s.io
  <span class="token key atrule">kind</span><span class="token punctuation">:</span> ClusterRole
  <span class="token key atrule">name</span><span class="token punctuation">:</span> ingress<span class="token punctuation">-</span>nginx
<span class="token key atrule">subjects</span><span class="token punctuation">:</span>
<span class="token punctuation">-</span> <span class="token key atrule">kind</span><span class="token punctuation">:</span> ServiceAccount
  <span class="token key atrule">name</span><span class="token punctuation">:</span> ingress<span class="token punctuation">-</span>nginx
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> ingress<span class="token punctuation">-</span>nginx
<span class="token punctuation">---</span>
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> rbac.authorization.k8s.io/v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> ClusterRoleBinding
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">labels</span><span class="token punctuation">:</span>
    <span class="token key atrule">app.kubernetes.io/component</span><span class="token punctuation">:</span> admission<span class="token punctuation">-</span>webhook
    <span class="token key atrule">app.kubernetes.io/instance</span><span class="token punctuation">:</span> ingress<span class="token punctuation">-</span>nginx
    <span class="token key atrule">app.kubernetes.io/name</span><span class="token punctuation">:</span> ingress<span class="token punctuation">-</span>nginx
    <span class="token key atrule">app.kubernetes.io/part-of</span><span class="token punctuation">:</span> ingress<span class="token punctuation">-</span>nginx
    <span class="token key atrule">app.kubernetes.io/version</span><span class="token punctuation">:</span> 1.7.1
  <span class="token key atrule">name</span><span class="token punctuation">:</span> ingress<span class="token punctuation">-</span>nginx<span class="token punctuation">-</span>admission
<span class="token key atrule">roleRef</span><span class="token punctuation">:</span>
  <span class="token key atrule">apiGroup</span><span class="token punctuation">:</span> rbac.authorization.k8s.io
  <span class="token key atrule">kind</span><span class="token punctuation">:</span> ClusterRole
  <span class="token key atrule">name</span><span class="token punctuation">:</span> ingress<span class="token punctuation">-</span>nginx<span class="token punctuation">-</span>admission
<span class="token key atrule">subjects</span><span class="token punctuation">:</span>
<span class="token punctuation">-</span> <span class="token key atrule">kind</span><span class="token punctuation">:</span> ServiceAccount
  <span class="token key atrule">name</span><span class="token punctuation">:</span> ingress<span class="token punctuation">-</span>nginx<span class="token punctuation">-</span>admission
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> ingress<span class="token punctuation">-</span>nginx
<span class="token punctuation">---</span>
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">data</span><span class="token punctuation">:</span>
  <span class="token key atrule">allow-snippet-annotations</span><span class="token punctuation">:</span> <span class="token string">"true"</span>
<span class="token key atrule">kind</span><span class="token punctuation">:</span> ConfigMap
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">labels</span><span class="token punctuation">:</span>
    <span class="token key atrule">app.kubernetes.io/component</span><span class="token punctuation">:</span> controller
    <span class="token key atrule">app.kubernetes.io/instance</span><span class="token punctuation">:</span> ingress<span class="token punctuation">-</span>nginx
    <span class="token key atrule">app.kubernetes.io/name</span><span class="token punctuation">:</span> ingress<span class="token punctuation">-</span>nginx
    <span class="token key atrule">app.kubernetes.io/part-of</span><span class="token punctuation">:</span> ingress<span class="token punctuation">-</span>nginx
    <span class="token key atrule">app.kubernetes.io/version</span><span class="token punctuation">:</span> 1.7.1
  <span class="token key atrule">name</span><span class="token punctuation">:</span> ingress<span class="token punctuation">-</span>nginx<span class="token punctuation">-</span>controller
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> ingress<span class="token punctuation">-</span>nginx
<span class="token punctuation">---</span>
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Service
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">labels</span><span class="token punctuation">:</span>
    <span class="token key atrule">app.kubernetes.io/component</span><span class="token punctuation">:</span> controller
    <span class="token key atrule">app.kubernetes.io/instance</span><span class="token punctuation">:</span> ingress<span class="token punctuation">-</span>nginx
    <span class="token key atrule">app.kubernetes.io/name</span><span class="token punctuation">:</span> ingress<span class="token punctuation">-</span>nginx
    <span class="token key atrule">app.kubernetes.io/part-of</span><span class="token punctuation">:</span> ingress<span class="token punctuation">-</span>nginx
    <span class="token key atrule">app.kubernetes.io/version</span><span class="token punctuation">:</span> 1.7.1
  <span class="token key atrule">name</span><span class="token punctuation">:</span> ingress<span class="token punctuation">-</span>nginx<span class="token punctuation">-</span>controller
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> ingress<span class="token punctuation">-</span>nginx
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">ipFamilies</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> IPv4
  <span class="token key atrule">ipFamilyPolicy</span><span class="token punctuation">:</span> SingleStack
  <span class="token key atrule">ports</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">appProtocol</span><span class="token punctuation">:</span> http
    <span class="token key atrule">name</span><span class="token punctuation">:</span> http
    <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">80</span>
    <span class="token key atrule">protocol</span><span class="token punctuation">:</span> TCP
    <span class="token key atrule">targetPort</span><span class="token punctuation">:</span> http
  <span class="token punctuation">-</span> <span class="token key atrule">appProtocol</span><span class="token punctuation">:</span> https
    <span class="token key atrule">name</span><span class="token punctuation">:</span> https
    <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">443</span>
    <span class="token key atrule">protocol</span><span class="token punctuation">:</span> TCP
    <span class="token key atrule">targetPort</span><span class="token punctuation">:</span> https
  <span class="token key atrule">selector</span><span class="token punctuation">:</span>
    <span class="token key atrule">app.kubernetes.io/component</span><span class="token punctuation">:</span> controller
    <span class="token key atrule">app.kubernetes.io/instance</span><span class="token punctuation">:</span> ingress<span class="token punctuation">-</span>nginx
    <span class="token key atrule">app.kubernetes.io/name</span><span class="token punctuation">:</span> ingress<span class="token punctuation">-</span>nginx
  <span class="token key atrule">type</span><span class="token punctuation">:</span> NodePort
<span class="token punctuation">---</span>
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Service
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">labels</span><span class="token punctuation">:</span>
    <span class="token key atrule">app.kubernetes.io/component</span><span class="token punctuation">:</span> controller
    <span class="token key atrule">app.kubernetes.io/instance</span><span class="token punctuation">:</span> ingress<span class="token punctuation">-</span>nginx
    <span class="token key atrule">app.kubernetes.io/name</span><span class="token punctuation">:</span> ingress<span class="token punctuation">-</span>nginx
    <span class="token key atrule">app.kubernetes.io/part-of</span><span class="token punctuation">:</span> ingress<span class="token punctuation">-</span>nginx
    <span class="token key atrule">app.kubernetes.io/version</span><span class="token punctuation">:</span> 1.7.1
  <span class="token key atrule">name</span><span class="token punctuation">:</span> ingress<span class="token punctuation">-</span>nginx<span class="token punctuation">-</span>controller<span class="token punctuation">-</span>admission
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> ingress<span class="token punctuation">-</span>nginx
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">ports</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">appProtocol</span><span class="token punctuation">:</span> https
    <span class="token key atrule">name</span><span class="token punctuation">:</span> https<span class="token punctuation">-</span>webhook
    <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">443</span>
    <span class="token key atrule">targetPort</span><span class="token punctuation">:</span> webhook
  <span class="token key atrule">selector</span><span class="token punctuation">:</span>
    <span class="token key atrule">app.kubernetes.io/component</span><span class="token punctuation">:</span> controller
    <span class="token key atrule">app.kubernetes.io/instance</span><span class="token punctuation">:</span> ingress<span class="token punctuation">-</span>nginx
    <span class="token key atrule">app.kubernetes.io/name</span><span class="token punctuation">:</span> ingress<span class="token punctuation">-</span>nginx
  <span class="token key atrule">type</span><span class="token punctuation">:</span> ClusterIP
<span class="token punctuation">---</span>
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> apps/v1
<span class="token comment">#kind: Deployment</span>
<span class="token key atrule">kind</span><span class="token punctuation">:</span> DaemonSet
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">labels</span><span class="token punctuation">:</span>
    <span class="token key atrule">app.kubernetes.io/component</span><span class="token punctuation">:</span> controller
    <span class="token key atrule">app.kubernetes.io/instance</span><span class="token punctuation">:</span> ingress<span class="token punctuation">-</span>nginx
    <span class="token key atrule">app.kubernetes.io/name</span><span class="token punctuation">:</span> ingress<span class="token punctuation">-</span>nginx
    <span class="token key atrule">app.kubernetes.io/part-of</span><span class="token punctuation">:</span> ingress<span class="token punctuation">-</span>nginx
    <span class="token key atrule">app.kubernetes.io/version</span><span class="token punctuation">:</span> 1.7.1
  <span class="token key atrule">name</span><span class="token punctuation">:</span> ingress<span class="token punctuation">-</span>nginx<span class="token punctuation">-</span>controller
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> ingress<span class="token punctuation">-</span>nginx
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">minReadySeconds</span><span class="token punctuation">:</span> <span class="token number">0</span>
  <span class="token key atrule">revisionHistoryLimit</span><span class="token punctuation">:</span> <span class="token number">10</span>
  <span class="token key atrule">selector</span><span class="token punctuation">:</span>
    <span class="token key atrule">matchLabels</span><span class="token punctuation">:</span>
      <span class="token key atrule">app.kubernetes.io/component</span><span class="token punctuation">:</span> controller
      <span class="token key atrule">app.kubernetes.io/instance</span><span class="token punctuation">:</span> ingress<span class="token punctuation">-</span>nginx
      <span class="token key atrule">app.kubernetes.io/name</span><span class="token punctuation">:</span> ingress<span class="token punctuation">-</span>nginx
  <span class="token key atrule">template</span><span class="token punctuation">:</span>
    <span class="token key atrule">metadata</span><span class="token punctuation">:</span>
      <span class="token key atrule">labels</span><span class="token punctuation">:</span>
        <span class="token key atrule">app.kubernetes.io/component</span><span class="token punctuation">:</span> controller
        <span class="token key atrule">app.kubernetes.io/instance</span><span class="token punctuation">:</span> ingress<span class="token punctuation">-</span>nginx
        <span class="token key atrule">app.kubernetes.io/name</span><span class="token punctuation">:</span> ingress<span class="token punctuation">-</span>nginx
        <span class="token key atrule">app.kubernetes.io/part-of</span><span class="token punctuation">:</span> ingress<span class="token punctuation">-</span>nginx
        <span class="token key atrule">app.kubernetes.io/version</span><span class="token punctuation">:</span> 1.7.1
    <span class="token key atrule">spec</span><span class="token punctuation">:</span>
      <span class="token key atrule">hostNetwork</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
      <span class="token key atrule">containers</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> <span class="token key atrule">args</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> /nginx<span class="token punctuation">-</span>ingress<span class="token punctuation">-</span>controller
        <span class="token punctuation">-</span> <span class="token punctuation">-</span><span class="token punctuation">-</span>election<span class="token punctuation">-</span>id=ingress<span class="token punctuation">-</span>nginx<span class="token punctuation">-</span>leader
        <span class="token punctuation">-</span> <span class="token punctuation">-</span><span class="token punctuation">-</span>controller<span class="token punctuation">-</span>class=k8s.io/ingress<span class="token punctuation">-</span>nginx
        <span class="token punctuation">-</span> <span class="token punctuation">-</span><span class="token punctuation">-</span>ingress<span class="token punctuation">-</span>class=nginx
        <span class="token punctuation">-</span> <span class="token punctuation">-</span><span class="token punctuation">-</span>configmap=$(POD_NAMESPACE)/ingress<span class="token punctuation">-</span>nginx<span class="token punctuation">-</span>controller
        <span class="token punctuation">-</span> <span class="token punctuation">-</span><span class="token punctuation">-</span>validating<span class="token punctuation">-</span>webhook=<span class="token punctuation">:</span><span class="token number">8443</span>
        <span class="token punctuation">-</span> <span class="token punctuation">-</span><span class="token punctuation">-</span>validating<span class="token punctuation">-</span>webhook<span class="token punctuation">-</span>certificate=/usr/local/certificates/cert
        <span class="token punctuation">-</span> <span class="token punctuation">-</span><span class="token punctuation">-</span>validating<span class="token punctuation">-</span>webhook<span class="token punctuation">-</span>key=/usr/local/certificates/key
        <span class="token key atrule">env</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> POD_NAME
          <span class="token key atrule">valueFrom</span><span class="token punctuation">:</span>
            <span class="token key atrule">fieldRef</span><span class="token punctuation">:</span>
              <span class="token key atrule">fieldPath</span><span class="token punctuation">:</span> metadata.name
        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> POD_NAMESPACE
          <span class="token key atrule">valueFrom</span><span class="token punctuation">:</span>
            <span class="token key atrule">fieldRef</span><span class="token punctuation">:</span>
              <span class="token key atrule">fieldPath</span><span class="token punctuation">:</span> metadata.namespace
        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> LD_PRELOAD
          <span class="token key atrule">value</span><span class="token punctuation">:</span> /usr/local/lib/libmimalloc.so
        <span class="token key atrule">image</span><span class="token punctuation">:</span> registry.cn<span class="token punctuation">-</span>beijing.aliyuncs.com/dotbalo/ingress<span class="token punctuation">-</span>nginx<span class="token punctuation">-</span>controller<span class="token punctuation">:</span>v1.7.1
        <span class="token key atrule">imagePullPolicy</span><span class="token punctuation">:</span> IfNotPresent
        <span class="token key atrule">lifecycle</span><span class="token punctuation">:</span>
          <span class="token key atrule">preStop</span><span class="token punctuation">:</span>
            <span class="token key atrule">exec</span><span class="token punctuation">:</span>
              <span class="token key atrule">command</span><span class="token punctuation">:</span>
              <span class="token punctuation">-</span> /wait<span class="token punctuation">-</span>shutdown
        <span class="token key atrule">livenessProbe</span><span class="token punctuation">:</span>
          <span class="token key atrule">failureThreshold</span><span class="token punctuation">:</span> <span class="token number">5</span>
          <span class="token key atrule">httpGet</span><span class="token punctuation">:</span>
            <span class="token key atrule">path</span><span class="token punctuation">:</span> /healthz
            <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">10254</span>
            <span class="token key atrule">scheme</span><span class="token punctuation">:</span> HTTP
          <span class="token key atrule">initialDelaySeconds</span><span class="token punctuation">:</span> <span class="token number">10</span>
          <span class="token key atrule">periodSeconds</span><span class="token punctuation">:</span> <span class="token number">10</span>
          <span class="token key atrule">successThreshold</span><span class="token punctuation">:</span> <span class="token number">1</span>
          <span class="token key atrule">timeoutSeconds</span><span class="token punctuation">:</span> <span class="token number">1</span>
        <span class="token key atrule">name</span><span class="token punctuation">:</span> controller
        <span class="token key atrule">ports</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> <span class="token key atrule">containerPort</span><span class="token punctuation">:</span> <span class="token number">80</span>
          <span class="token key atrule">name</span><span class="token punctuation">:</span> http
          <span class="token key atrule">protocol</span><span class="token punctuation">:</span> TCP
        <span class="token punctuation">-</span> <span class="token key atrule">containerPort</span><span class="token punctuation">:</span> <span class="token number">443</span>
          <span class="token key atrule">name</span><span class="token punctuation">:</span> https
          <span class="token key atrule">protocol</span><span class="token punctuation">:</span> TCP
        <span class="token punctuation">-</span> <span class="token key atrule">containerPort</span><span class="token punctuation">:</span> <span class="token number">8443</span>
          <span class="token key atrule">name</span><span class="token punctuation">:</span> webhook
          <span class="token key atrule">protocol</span><span class="token punctuation">:</span> TCP
        <span class="token key atrule">readinessProbe</span><span class="token punctuation">:</span>
          <span class="token key atrule">failureThreshold</span><span class="token punctuation">:</span> <span class="token number">3</span>
          <span class="token key atrule">httpGet</span><span class="token punctuation">:</span>
            <span class="token key atrule">path</span><span class="token punctuation">:</span> /healthz
            <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">10254</span>
            <span class="token key atrule">scheme</span><span class="token punctuation">:</span> HTTP
          <span class="token key atrule">initialDelaySeconds</span><span class="token punctuation">:</span> <span class="token number">10</span>
          <span class="token key atrule">periodSeconds</span><span class="token punctuation">:</span> <span class="token number">10</span>
          <span class="token key atrule">successThreshold</span><span class="token punctuation">:</span> <span class="token number">1</span>
          <span class="token key atrule">timeoutSeconds</span><span class="token punctuation">:</span> <span class="token number">1</span>
        <span class="token key atrule">resources</span><span class="token punctuation">:</span>
          <span class="token key atrule">requests</span><span class="token punctuation">:</span>
            <span class="token key atrule">cpu</span><span class="token punctuation">:</span> 100m
            <span class="token key atrule">memory</span><span class="token punctuation">:</span> 90Mi
        <span class="token key atrule">securityContext</span><span class="token punctuation">:</span>
          <span class="token key atrule">allowPrivilegeEscalation</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
          <span class="token key atrule">capabilities</span><span class="token punctuation">:</span>
            <span class="token key atrule">add</span><span class="token punctuation">:</span>
            <span class="token punctuation">-</span> NET_BIND_SERVICE
            <span class="token key atrule">drop</span><span class="token punctuation">:</span>
            <span class="token punctuation">-</span> ALL
          <span class="token key atrule">runAsUser</span><span class="token punctuation">:</span> <span class="token number">101</span>
        <span class="token key atrule">volumeMounts</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> <span class="token key atrule">mountPath</span><span class="token punctuation">:</span> /usr/local/certificates/
          <span class="token key atrule">name</span><span class="token punctuation">:</span> webhook<span class="token punctuation">-</span>cert
          <span class="token key atrule">readOnly</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
      // 更改dns解析策略
      <span class="token comment">#dnsPolicy: ClusterFirst</span>
      <span class="token key atrule">dnsPolicy</span><span class="token punctuation">:</span> ClusterFirstWithHostNet
      <span class="token key atrule">nodeSelector</span><span class="token punctuation">:</span>
        <span class="token key atrule">kubernetes.io/os</span><span class="token punctuation">:</span> linux
        <span class="token key atrule">ingress</span><span class="token punctuation">:</span> <span class="token string">"true"</span>
      <span class="token key atrule">serviceAccountName</span><span class="token punctuation">:</span> ingress<span class="token punctuation">-</span>nginx
      <span class="token key atrule">terminationGracePeriodSeconds</span><span class="token punctuation">:</span> <span class="token number">300</span>
      <span class="token key atrule">volumes</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> webhook<span class="token punctuation">-</span>cert
        <span class="token key atrule">secret</span><span class="token punctuation">:</span>
          <span class="token key atrule">secretName</span><span class="token punctuation">:</span> ingress<span class="token punctuation">-</span>nginx<span class="token punctuation">-</span>admission
<span class="token punctuation">---</span>
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> batch/v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Job
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">labels</span><span class="token punctuation">:</span>
    <span class="token key atrule">app.kubernetes.io/component</span><span class="token punctuation">:</span> admission<span class="token punctuation">-</span>webhook
    <span class="token key atrule">app.kubernetes.io/instance</span><span class="token punctuation">:</span> ingress<span class="token punctuation">-</span>nginx
    <span class="token key atrule">app.kubernetes.io/name</span><span class="token punctuation">:</span> ingress<span class="token punctuation">-</span>nginx
    <span class="token key atrule">app.kubernetes.io/part-of</span><span class="token punctuation">:</span> ingress<span class="token punctuation">-</span>nginx
    <span class="token key atrule">app.kubernetes.io/version</span><span class="token punctuation">:</span> 1.7.1
  <span class="token key atrule">name</span><span class="token punctuation">:</span> ingress<span class="token punctuation">-</span>nginx<span class="token punctuation">-</span>admission<span class="token punctuation">-</span>create
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> ingress<span class="token punctuation">-</span>nginx
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">template</span><span class="token punctuation">:</span>
    <span class="token key atrule">metadata</span><span class="token punctuation">:</span>
      <span class="token key atrule">labels</span><span class="token punctuation">:</span>
        <span class="token key atrule">app.kubernetes.io/component</span><span class="token punctuation">:</span> admission<span class="token punctuation">-</span>webhook
        <span class="token key atrule">app.kubernetes.io/instance</span><span class="token punctuation">:</span> ingress<span class="token punctuation">-</span>nginx
        <span class="token key atrule">app.kubernetes.io/name</span><span class="token punctuation">:</span> ingress<span class="token punctuation">-</span>nginx
        <span class="token key atrule">app.kubernetes.io/part-of</span><span class="token punctuation">:</span> ingress<span class="token punctuation">-</span>nginx
        <span class="token key atrule">app.kubernetes.io/version</span><span class="token punctuation">:</span> 1.7.1
      <span class="token key atrule">name</span><span class="token punctuation">:</span> ingress<span class="token punctuation">-</span>nginx<span class="token punctuation">-</span>admission<span class="token punctuation">-</span>create
    <span class="token key atrule">spec</span><span class="token punctuation">:</span>
      <span class="token key atrule">containers</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> <span class="token key atrule">args</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> create
        <span class="token punctuation">-</span> <span class="token punctuation">-</span><span class="token punctuation">-</span>host=ingress<span class="token punctuation">-</span>nginx<span class="token punctuation">-</span>controller<span class="token punctuation">-</span>admission<span class="token punctuation">,</span>ingress<span class="token punctuation">-</span>nginx<span class="token punctuation">-</span>controller<span class="token punctuation">-</span>admission.$(POD_NAMESPACE).svc
        <span class="token punctuation">-</span> <span class="token punctuation">-</span><span class="token punctuation">-</span>namespace=$(POD_NAMESPACE)
        <span class="token punctuation">-</span> <span class="token punctuation">-</span><span class="token punctuation">-</span>secret<span class="token punctuation">-</span>name=ingress<span class="token punctuation">-</span>nginx<span class="token punctuation">-</span>admission
        <span class="token key atrule">env</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> POD_NAMESPACE
          <span class="token key atrule">valueFrom</span><span class="token punctuation">:</span>
            <span class="token key atrule">fieldRef</span><span class="token punctuation">:</span>
              <span class="token key atrule">fieldPath</span><span class="token punctuation">:</span> metadata.namespace
        <span class="token key atrule">image</span><span class="token punctuation">:</span> registry.cn<span class="token punctuation">-</span>beijing.aliyuncs.com/dotbalo/kube<span class="token punctuation">-</span>webhook<span class="token punctuation">-</span>certgen<span class="token punctuation">:</span>v20230312
        <span class="token key atrule">imagePullPolicy</span><span class="token punctuation">:</span> IfNotPresent
        <span class="token key atrule">name</span><span class="token punctuation">:</span> create
        <span class="token key atrule">securityContext</span><span class="token punctuation">:</span>
          <span class="token key atrule">allowPrivilegeEscalation</span><span class="token punctuation">:</span> <span class="token boolean important">false</span>
      <span class="token key atrule">nodeSelector</span><span class="token punctuation">:</span>
        <span class="token key atrule">kubernetes.io/os</span><span class="token punctuation">:</span> linux
      <span class="token key atrule">restartPolicy</span><span class="token punctuation">:</span> OnFailure
      <span class="token key atrule">securityContext</span><span class="token punctuation">:</span>
        <span class="token key atrule">fsGroup</span><span class="token punctuation">:</span> <span class="token number">2000</span>
        <span class="token key atrule">runAsNonRoot</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
        <span class="token key atrule">runAsUser</span><span class="token punctuation">:</span> <span class="token number">2000</span>
      <span class="token key atrule">serviceAccountName</span><span class="token punctuation">:</span> ingress<span class="token punctuation">-</span>nginx<span class="token punctuation">-</span>admission
<span class="token punctuation">---</span>
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> batch/v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Job
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">labels</span><span class="token punctuation">:</span>
    <span class="token key atrule">app.kubernetes.io/component</span><span class="token punctuation">:</span> admission<span class="token punctuation">-</span>webhook
    <span class="token key atrule">app.kubernetes.io/instance</span><span class="token punctuation">:</span> ingress<span class="token punctuation">-</span>nginx
    <span class="token key atrule">app.kubernetes.io/name</span><span class="token punctuation">:</span> ingress<span class="token punctuation">-</span>nginx
    <span class="token key atrule">app.kubernetes.io/part-of</span><span class="token punctuation">:</span> ingress<span class="token punctuation">-</span>nginx
    <span class="token key atrule">app.kubernetes.io/version</span><span class="token punctuation">:</span> 1.7.1
  <span class="token key atrule">name</span><span class="token punctuation">:</span> ingress<span class="token punctuation">-</span>nginx<span class="token punctuation">-</span>admission<span class="token punctuation">-</span>patch
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> ingress<span class="token punctuation">-</span>nginx
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">template</span><span class="token punctuation">:</span>
    <span class="token key atrule">metadata</span><span class="token punctuation">:</span>
      <span class="token key atrule">labels</span><span class="token punctuation">:</span>
        <span class="token key atrule">app.kubernetes.io/component</span><span class="token punctuation">:</span> admission<span class="token punctuation">-</span>webhook
        <span class="token key atrule">app.kubernetes.io/instance</span><span class="token punctuation">:</span> ingress<span class="token punctuation">-</span>nginx
        <span class="token key atrule">app.kubernetes.io/name</span><span class="token punctuation">:</span> ingress<span class="token punctuation">-</span>nginx
        <span class="token key atrule">app.kubernetes.io/part-of</span><span class="token punctuation">:</span> ingress<span class="token punctuation">-</span>nginx
        <span class="token key atrule">app.kubernetes.io/version</span><span class="token punctuation">:</span> 1.7.1
      <span class="token key atrule">name</span><span class="token punctuation">:</span> ingress<span class="token punctuation">-</span>nginx<span class="token punctuation">-</span>admission<span class="token punctuation">-</span>patch
    <span class="token key atrule">spec</span><span class="token punctuation">:</span>
      <span class="token key atrule">containers</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> <span class="token key atrule">args</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> patch
        <span class="token punctuation">-</span> <span class="token punctuation">-</span><span class="token punctuation">-</span>webhook<span class="token punctuation">-</span>name=ingress<span class="token punctuation">-</span>nginx<span class="token punctuation">-</span>admission
        <span class="token punctuation">-</span> <span class="token punctuation">-</span><span class="token punctuation">-</span>namespace=$(POD_NAMESPACE)
        <span class="token punctuation">-</span> <span class="token punctuation">-</span><span class="token punctuation">-</span>patch<span class="token punctuation">-</span>mutating=false
        <span class="token punctuation">-</span> <span class="token punctuation">-</span><span class="token punctuation">-</span>secret<span class="token punctuation">-</span>name=ingress<span class="token punctuation">-</span>nginx<span class="token punctuation">-</span>admission
        <span class="token punctuation">-</span> <span class="token punctuation">-</span><span class="token punctuation">-</span>patch<span class="token punctuation">-</span>failure<span class="token punctuation">-</span>policy=Fail
        <span class="token key atrule">env</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> POD_NAMESPACE
          <span class="token key atrule">valueFrom</span><span class="token punctuation">:</span>
            <span class="token key atrule">fieldRef</span><span class="token punctuation">:</span>
              <span class="token key atrule">fieldPath</span><span class="token punctuation">:</span> metadata.namespace
        <span class="token key atrule">image</span><span class="token punctuation">:</span> registry.cn<span class="token punctuation">-</span>beijing.aliyuncs.com/dotbalo/kube<span class="token punctuation">-</span>webhook<span class="token punctuation">-</span>certgen<span class="token punctuation">:</span>v20230312
        <span class="token key atrule">imagePullPolicy</span><span class="token punctuation">:</span> IfNotPresent
        <span class="token key atrule">name</span><span class="token punctuation">:</span> patch
        <span class="token key atrule">securityContext</span><span class="token punctuation">:</span>
          <span class="token key atrule">allowPrivilegeEscalation</span><span class="token punctuation">:</span> <span class="token boolean important">false</span>
      <span class="token key atrule">nodeSelector</span><span class="token punctuation">:</span>
        <span class="token key atrule">kubernetes.io/os</span><span class="token punctuation">:</span> linux
      <span class="token key atrule">restartPolicy</span><span class="token punctuation">:</span> OnFailure
      <span class="token key atrule">securityContext</span><span class="token punctuation">:</span>
        <span class="token key atrule">fsGroup</span><span class="token punctuation">:</span> <span class="token number">2000</span>
        <span class="token key atrule">runAsNonRoot</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
        <span class="token key atrule">runAsUser</span><span class="token punctuation">:</span> <span class="token number">2000</span>
      <span class="token key atrule">serviceAccountName</span><span class="token punctuation">:</span> ingress<span class="token punctuation">-</span>nginx<span class="token punctuation">-</span>admission
<span class="token punctuation">---</span>
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> networking.k8s.io/v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> IngressClass
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">labels</span><span class="token punctuation">:</span>
    <span class="token key atrule">app.kubernetes.io/component</span><span class="token punctuation">:</span> controller
    <span class="token key atrule">app.kubernetes.io/instance</span><span class="token punctuation">:</span> ingress<span class="token punctuation">-</span>nginx
    <span class="token key atrule">app.kubernetes.io/name</span><span class="token punctuation">:</span> ingress<span class="token punctuation">-</span>nginx
    <span class="token key atrule">app.kubernetes.io/part-of</span><span class="token punctuation">:</span> ingress<span class="token punctuation">-</span>nginx
    <span class="token key atrule">app.kubernetes.io/version</span><span class="token punctuation">:</span> 1.7.1
  <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">controller</span><span class="token punctuation">:</span> k8s.io/ingress<span class="token punctuation">-</span>nginx
<span class="token punctuation">---</span>
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> admissionregistration.k8s.io/v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> ValidatingWebhookConfiguration
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">labels</span><span class="token punctuation">:</span>
    <span class="token key atrule">app.kubernetes.io/component</span><span class="token punctuation">:</span> admission<span class="token punctuation">-</span>webhook
    <span class="token key atrule">app.kubernetes.io/instance</span><span class="token punctuation">:</span> ingress<span class="token punctuation">-</span>nginx
    <span class="token key atrule">app.kubernetes.io/name</span><span class="token punctuation">:</span> ingress<span class="token punctuation">-</span>nginx
    <span class="token key atrule">app.kubernetes.io/part-of</span><span class="token punctuation">:</span> ingress<span class="token punctuation">-</span>nginx
    <span class="token key atrule">app.kubernetes.io/version</span><span class="token punctuation">:</span> 1.7.1
  <span class="token key atrule">name</span><span class="token punctuation">:</span> ingress<span class="token punctuation">-</span>nginx<span class="token punctuation">-</span>admission
<span class="token key atrule">webhooks</span><span class="token punctuation">:</span>
<span class="token punctuation">-</span> <span class="token key atrule">admissionReviewVersions</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> v1
  <span class="token key atrule">clientConfig</span><span class="token punctuation">:</span>
    <span class="token key atrule">service</span><span class="token punctuation">:</span>
      <span class="token key atrule">name</span><span class="token punctuation">:</span> ingress<span class="token punctuation">-</span>nginx<span class="token punctuation">-</span>controller<span class="token punctuation">-</span>admission
      <span class="token key atrule">namespace</span><span class="token punctuation">:</span> ingress<span class="token punctuation">-</span>nginx
      <span class="token key atrule">path</span><span class="token punctuation">:</span> /networking/v1/ingresses
  <span class="token key atrule">failurePolicy</span><span class="token punctuation">:</span> Fail
  <span class="token key atrule">matchPolicy</span><span class="token punctuation">:</span> Equivalent
  <span class="token key atrule">name</span><span class="token punctuation">:</span> validate.nginx.ingress.kubernetes.io
  <span class="token key atrule">rules</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">apiGroups</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> networking.k8s.io
    <span class="token key atrule">apiVersions</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> v1
    <span class="token key atrule">operations</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> CREATE
    <span class="token punctuation">-</span> UPDATE
    <span class="token key atrule">resources</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> ingresses
  <span class="token key atrule">sideEffects</span><span class="token punctuation">:</span> None
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>


<pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml">root@VM<span class="token punctuation">-</span>26<span class="token punctuation">-</span>130<span class="token punctuation">-</span>ubuntu<span class="token punctuation">:</span>/usr/local/src/k8s<span class="token comment"># kubectl get pods -n ingress-nginx </span>
NAME                                      READY   STATUS      RESTARTS   AGE
ingress<span class="token punctuation">-</span>nginx<span class="token punctuation">-</span>admission<span class="token punctuation">-</span>create<span class="token punctuation">-</span><span class="token punctuation">-</span>1<span class="token punctuation">-</span>5c74h   0/1     Completed   0          13m
ingress<span class="token punctuation">-</span>nginx<span class="token punctuation">-</span>admission<span class="token punctuation">-</span>patch<span class="token punctuation">-</span><span class="token punctuation">-</span>1<span class="token punctuation">-</span>gs92r    0/1     Completed   0          13m
ingress<span class="token punctuation">-</span>nginx<span class="token punctuation">-</span>controller<span class="token punctuation">-</span>4frtd            1/1     Running     0          13m
ingress<span class="token punctuation">-</span>nginx<span class="token punctuation">-</span>controller<span class="token punctuation">-</span>sgcg2            1/1     Running     0          13m
ingress<span class="token punctuation">-</span>nginx<span class="token punctuation">-</span>controller<span class="token punctuation">-</span>tpndn            1/1     Running     0          13m<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="二、ingress使用"><a href="#二、ingress使用" class="headerlink" title="二、ingress使用"></a>二、ingress使用</h3><h5 id="2-1-资源定义"><a href="#2-1-资源定义" class="headerlink" title="2.1 资源定义"></a>2.1 资源定义</h5><pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">kind</span><span class="token punctuation">:</span> Ingress
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
 <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx<span class="token punctuation">-</span>ingress
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
 <span class="token key atrule">ingressClassName</span><span class="token punctuation">:</span> nginx <span class="token comment"># 指定该 Ingress 被哪个 Controller 解析</span>
 <span class="token key atrule">rules</span><span class="token punctuation">:</span> <span class="token comment"># 定义路由匹配规则，可以配置多个</span>
 <span class="token punctuation">-</span> <span class="token key atrule">host</span><span class="token punctuation">:</span> nginx.test.com <span class="token comment"># 定义域名</span>
   <span class="token key atrule">http</span><span class="token punctuation">:</span> <span class="token comment"># </span>
     <span class="token key atrule">paths</span><span class="token punctuation">:</span> <span class="token comment"># 详细的路由配置，可以配置多个</span>
     <span class="token punctuation">-</span> <span class="token key atrule">backend</span><span class="token punctuation">:</span> <span class="token comment"># 指定该路由的后端</span>
         <span class="token key atrule">service</span><span class="token punctuation">:</span>
           <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx
           <span class="token key atrule">port</span><span class="token punctuation">:</span>
             <span class="token key atrule">number</span><span class="token punctuation">:</span> <span class="token number">80</span>
       <span class="token key atrule">path</span><span class="token punctuation">:</span> / <span class="token comment"># 指定 PATH</span>
       <span class="token key atrule">pathType</span><span class="token punctuation">:</span> ImplementationSpecific <span class="token comment"># 指定匹配规则</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p><code>pathType</code>：路径的匹配方式，目前有 <code>ImplementationSpecific</code>、<code>Exact</code> 和 <code>Prefix</code> 方式</p>
<ul>
<li><code>Exact</code>：精确匹配，比如配置的 path 为&#x2F;bar，那么&#x2F;bar&#x2F;将不能被路由；</li>
<li><code>Prefix</code>：前缀匹配，基于以 &#x2F; 分隔的 URL 路径。比如 path 为&#x2F;abc，可以匹配到&#x2F;abc&#x2F;bbb等，比较常用的配置；</li>
<li><code>ImplementationSpecific</code>：这种类型的路由匹配根据 Ingress Controller 来实现，可以当做一个单独的类型，也可以当做 Prefix 和 Exact。ImplementationSpecific 是 1.18 版本引入 Prefix 和 Exact 的默认配置。</li>
</ul>
<h5 id="2-2-Ingress入门"><a href="#2-2-Ingress入门" class="headerlink" title="2.2 Ingress入门"></a>2.2 Ingress入门</h5><p>Ingress Nginx 配置文档： <a target="_blank" rel="noopener" href="https://kubernetes.github.io/ingress-nginx/user-guide/nginx-configuration/annotations/">https://kubernetes.github.io/ingress-nginx/user-guide/nginx-configuration/annotations/</a></p>
<h6 id="2-2-1-使用域名发布K8S服务"><a href="#2-2-1-使用域名发布K8S服务" class="headerlink" title="2.2.1 使用域名发布K8S服务"></a>2.2.1 使用域名发布K8S服务</h6><p>创建一个web服务：</p>
<pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml">root@VM<span class="token punctuation">-</span>26<span class="token punctuation">-</span>130<span class="token punctuation">-</span>ubuntu<span class="token punctuation">:</span>/usr/local/src/k8s/ingress<span class="token comment"># kubectl create deploy nginx --image=registry.cn-beijing.aliyuncs.com/dotbalo/nginx:1.15.12</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>暴露服务</p>
<pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml">kubectl expose deploy nginx <span class="token punctuation">-</span><span class="token punctuation">-</span>port 80<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>创建ingress</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">root@VM-26-130-ubuntu:/usr/local/src/k8s/ingress<span class="token comment"># vim web-ingress.yaml </span>
apiVersion: networking.k8s.io/v1 <span class="token comment"># k8s >= 1.22 必须 v1</span>
kind: Ingress
metadata:
 name: nginx-ingress
spec:
 ingressClassName: nginx <span class="token comment"># 指定该 Ingress 被哪个 Controller 解析</span>
 rules: <span class="token comment"># 定义路由匹配规则，可以配置多个</span>
 - host: dujie.test.com <span class="token comment"># 定义域名</span>
   http: <span class="token comment"># </span>
     paths: <span class="token comment"># 详细的路由配置，可以配置多个</span>
     - backend: <span class="token comment"># 指定该路由的后端</span>
         service:
           name: nginx
           port:
             number: <span class="token number">80</span>
       path: / <span class="token comment"># 指定 PATH</span>
       pathType: ImplementationSpecific <span class="token comment"># 指定匹配规则</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h6 id="2-2-2-Ingress特例：不配置域名发布服务"><a href="#2-2-2-Ingress特例：不配置域名发布服务" class="headerlink" title="2.2.2 Ingress特例：不配置域名发布服务"></a>2.2.2 Ingress特例：不配置域名发布服务</h6><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">root@VM-26-130-ubuntu:/usr/local/src/k8s/ingress<span class="token comment"># cat ingress-no-host.yaml </span>
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
 name: nginx-ingress-no-host
spec:
 ingressClassName: nginx
 rules:
 - http:
     paths:
     - backend:
        service:
          name: nginx
          port:
            number: <span class="token number">80</span>
       path: /no-host
       pathType: ImplementationSpecific<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>


<h5 id="2-3-Ingress实战"><a href="#2-3-Ingress实战" class="headerlink" title="2.3 Ingress实战"></a>2.3 Ingress实战</h5><p>环境准备</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">root@VM-26-130-ubuntu:/usr/local/src/k8s/ingress<span class="token comment"># kubectl create ns study-ingress </span>
namespace/study-ingress created
root@VM-26-130-ubuntu:/usr/local/src/k8s/ingress<span class="token comment"># </span>
root@VM-26-130-ubuntu:/usr/local/src/k8s/ingress<span class="token comment"># kubectl create deployment nginx --image=registry.cn-beijing.aliyuncs.com/dotbalo/nginx:1.15.12 -n study-ingress</span>
deployment.apps/nginx created
root@VM-26-130-ubuntu:/usr/local/src/k8s/ingress<span class="token comment"># kubectl expose deployment nginx --port 80 -n study-ingress </span>
service/nginx exposed<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h6 id="2-3-1-使用HTTPS发布服务"><a href="#2-3-1-使用HTTPS发布服务" class="headerlink" title="2.3.1 使用HTTPS发布服务"></a>2.3.1 使用HTTPS发布服务</h6><p>生产环境对外的服务，一般需要配置https协议，使用Ingress可以非常方便添加https证书。</p>
<p>测试环境，手动生成证书</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">root@VM-26-130-ubuntu:/usr/local/src/k8s/ingress<span class="token comment">#  openssl req -x509 -nodes -days 365 -newkey rsa:2048 -keyout tls.key -out tls.crt -subj "/CN=dujie.test.com"</span>
Can<span class="token string">'t load /root/.rnd into RNG
140457963239232:error:2406F079:random number generator:RAND_load_file:Cannot open file:../crypto/rand/randfile.c:88:Filename=/root/.rnd
Generating a RSA private key
......................+++++
..............................+++++
writing new private key to '</span>tls.key'
-----
root@VM-26-130-ubuntu:/usr/local/src/k8s/ingress<span class="token comment"># kubectl create secret tls ca-secret --cert=tls.crt --key=tls.key </span>
secret/ca-secret created<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>配置Ingress添加TLS配置：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">root@VM-26-130-ubuntu:/usr/local/src/k8s/ingress<span class="token comment"># cat tls-ingress.yaml </span>
apiVersion: networking.k8s.io/v1 <span class="token comment"># k8s >= 1.22 必须 v1</span>
kind: Ingress
metadata:
 name: nginx-ingress
 namespace: study-ingress
spec:
 ingressClassName: nginx <span class="token comment"># 指定该 Ingress 被哪个 Controller 解析</span>
 tls:
 - hosts:
   - dujie.test.com
   secretName: ca-secret
 rules: <span class="token comment"># 定义路由匹配规则，可以配置多个</span>
 - host: dujie.test.com <span class="token comment"># 定义域名</span>
   http: <span class="token comment"># </span>
     paths: <span class="token comment"># 详细的路由配置，可以配置多个</span>
     - backend: <span class="token comment"># 指定该路由的后端</span>
         service:
           name: nginx
           port:
             number: <span class="token number">80</span>
       path: / <span class="token comment"># 指定 PATH</span>
       pathType: ImplementationSpecific <span class="token comment"># 指定匹配规则</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>更新ingress之后访问测试可以看到域名已经被重定向到https</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">root@VM-26-130-ubuntu:/usr/local/src/k8s/ingress<span class="token comment"># curl http://dujie.test.com -I</span>
HTTP/1.1 <span class="token number">308</span> Permanent Redirect
Date: Tue, <span class="token number">25</span> Mar <span class="token number">2025</span> 07:14:44 GMT
Content-Type: text/html
Content-Length: <span class="token number">164</span>
Connection: keep-alive
Location: https://dujie.test.com<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h6 id="2-3-2-域名添加用户名密码认证"><a href="#2-3-2-域名添加用户名密码认证" class="headerlink" title="2.3.2 域名添加用户名密码认证"></a>2.3.2 域名添加用户名密码认证</h6><p>有些开源工具本身不提供密码认证，如果暴露出去会有很大风险，对于这类工具可以使用Nginx 的 basic-auth 设置密码访问，具体方法如下，由于需要使用 htpasswd 工具，所以需要安装httpd：</p>
<p>ubuntu是apache2，centos是httpd</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">root@VM-26-130-ubuntu:/usr/local/src/k8s/ingress<span class="token comment"># apt install apache2</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>使用 htpasswd 创建 dujie 用户的密码：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">root@VM-26-130-ubuntu:/usr/local/src/k8s/ingress<span class="token comment"># htpasswd -c auth dujie</span>
New password: 
Re-type new password: 
Adding password <span class="token keyword">for</span> user dujie
root@VM-26-130-ubuntu:/usr/local/src/k8s/ingress<span class="token comment"># </span>
root@VM-26-130-ubuntu:/usr/local/src/k8s/ingress<span class="token comment"># cat auth </span>
dujie:<span class="token variable">$apr1</span><span class="token variable">$3MhHcDfm</span><span class="token variable">$CRmPVqklX2qhNg8FtV9pR</span>/<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>基于之前创建的密码文件创建secret</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">root@VM-26-130-ubuntu:/usr/local/src/k8s/ingress<span class="token comment"># kubectl create secret generic basic-auth --from-file=auth -n study-ingress  </span>
secret/basic-auth created<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p>创建包含密码认证的Ingress</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">root@VM-26-130-ubuntu:/usr/local/src/k8s/ingress<span class="token comment"># cat auth-ingress.yaml </span>
apiVersion: networking.k8s.io/v1 <span class="token comment"># k8s >= 1.22 必须 v1</span>
kind: Ingress
metadata:
 name: nginx-ingress
 namespace: study-ingress
 annotations:
   nginx.ingress.kubernetes.io/auth-realm: Please Input Your Username and Password
   nginx.ingress.kubernetes.io/auth-secret: basic-auth
   nginx.ingress.kubernetes.io/auth-type: basic
spec:
 ingressClassName: nginx <span class="token comment"># 指定该 Ingress 被哪个 Controller 解析</span>
 tls:
 - hosts:
   - dujie.test.com
   secretName: ca-secret
 rules: <span class="token comment"># 定义路由匹配规则，可以配置多个</span>
 - host: dujie.test.com <span class="token comment"># 定义域名</span>
   http: <span class="token comment"># </span>
     paths: <span class="token comment"># 详细的路由配置，可以配置多个</span>
     - backend: <span class="token comment"># 指定该路由的后端</span>
         service:
           name: nginx
           port:
             number: <span class="token number">80</span>
       path: / <span class="token comment"># 指定 PATH</span>
       pathType: ImplementationSpecific <span class="token comment"># 指定匹配规则</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>


<ul>
<li>nginx.ingress.kubernetes.io&#x2F;auth-type：认证类型，可以是 basic 和 digest</li>
<li>nginx.ingress.kubernetes.io&#x2F;auth-secret：密码文件的 Secret 名称</li>
<li>nginx.ingress.kubernetes.io&#x2F;auth-realm：需要密码认证的消息提醒</li>
</ul>
<p>创建该 Ingress，并访问测试：</p>
<p><img src="/images/s1s7et0jpy3aQDJYtZk_Oxb8FZncSOQCIRkSUrKYYtw.png" alt="image"></p>
<h6 id="2-3-3-开启会话保持"><a href="#2-3-3-开启会话保持" class="headerlink" title="2.3.3 开启会话保持"></a>2.3.3 开启会话保持</h6><p>和 Nginx 一样，Ingress Nginx 也支持基于 cookie 的会话保持。</p>
<p>首先扩容 nginx 服务至多个副本：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">root@VM-26-130-ubuntu:/usr/local/src/k8s/ingress<span class="token comment"># kubectl scale deployment  -n study-ingress  nginx  --replicas=3</span>
deployment.apps/nginx scaled
root@VM-26-130-ubuntu:/usr/local/src/k8s/ingress<span class="token comment"># kubectl get pods -n study-ingress </span>
NAME                     READY   STATUS              RESTARTS   AGE
nginx-785999d887-77kls   <span class="token number">1</span>/1     Running             <span class="token number">0</span>          43m
nginx-785999d887-8sld8   <span class="token number">0</span>/1     ContainerCreating   <span class="token number">0</span>          2s
nginx-785999d887-gg6wz   <span class="token number">0</span>/1     ContainerCreating   <span class="token number">0</span>          2s<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>未开启会话保持，同一个主机访问可以看到流量会在三个副本中都有。</p>
<p>通过以下配置，即可看到流量只会进入到一个 Pod：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">apiVersion: networking.k8s.io/v1 <span class="token comment"># k8s >= 1.22 必须 v1</span>
kind: Ingress
metadata:
 name: nginx-ingress
 namespace: study-ingress
 annotations:
   nginx.ingress.kubernetes.io/proxy-body-size: 16m
   nginx.ingress.kubernetes.io/affinity: <span class="token string">"cookie"</span>
   nginx.ingress.kubernetes.io/session-cookie-name: <span class="token string">"route"</span>
 <span class="token comment"># 过期时间，expires 兼容旧版浏览器</span>
   nginx.ingress.kubernetes.io/session-cookie-expires: <span class="token string">"172800"</span>
   nginx.ingress.kubernetes.io/session-cookie-max-age: <span class="token string">"172800"</span>
 <span class="token comment"># 后端负载扩容后，是否需要重新分配流量，balanced: 重新分配 persistent: 保持粘性</span>
   nginx.ingress.kubernetes.io/affinity-mode: persistent
spec:
 ingressClassName: nginx <span class="token comment"># 指定该 Ingress 被哪个 Controller 解析</span>
 tls:
 - hosts:
   - dujie.test.com
   secretName: ca-secret
 rules: <span class="token comment"># 定义路由匹配规则，可以配置多个</span>
 - host: dujie.test.com <span class="token comment"># 定义域名</span>
   http: <span class="token comment"># </span>
     paths: <span class="token comment"># 详细的路由配置，可以配置多个</span>
     - backend: <span class="token comment"># 指定该路由的后端</span>
         service:
           name: nginx
           port:
             number: <span class="token number">80</span>
       path: / <span class="token comment"># 指定 PATH</span>
       pathType: ImplementationSpecific <span class="token comment"># 指定匹配规则</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>同时浏览器的 request headers 会添加一个 Cookie 的属性：</p>
<p><img src="/images/9U1UBWkklCLvz5NtdbiiqW0upDFQMjz0K1HxTih0imE.png" alt="image"></p>
<p>流量重新分配，更改 nginx.ingress.kubernetes.io&#x2F;affinity-mode: balanced 即可：</p>
<p><img src="/images/S3k66uXqUO_44FJHQS-gjbctJjAMvJzqzmQRqZZGU5k.png" alt="image"></p>
<p>再次扩容后，就会发现流量会重新分配到其他节点。</p>
<h6 id="2-3-4-配置流式返回SSE（代理大模型服务）"><a href="#2-3-4-配置流式返回SSE（代理大模型服务）" class="headerlink" title="2.3.4 配置流式返回SSE（代理大模型服务）"></a>2.3.4 配置流式返回SSE（代理大模型服务）</h6><p>如果后端需要持续的输出数据，或者需要长连接，此时需要更改请求头升级链接为长连接</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">apiVersion: networking.k8s.io/v1 <span class="token comment"># k8s >= 1.22 必须 v1</span>
kind: Ingress
metadata:
 name: nginx-ingress
 namespace: study-ingress
 annotations:
   nginx.ingress.kubernetes.io/proxy-http-version: <span class="token string">"1.1"</span>
   nginx.ingress.kubernetes.io/proxy-buffering: <span class="token string">"off"</span>
 <span class="token comment"># snippet 通常用于配置一些不支持或者复杂的参数，比如配置请求头，或者逻辑控制</span>
   nginx.ingress.kubernetes.io/configuration-snippet: <span class="token operator">|</span>
      proxy_set_header Updrade <span class="token variable">$http_updrade</span><span class="token punctuation">;</span>
      proxy_set_header Connection <span class="token string">'upgrade'</span><span class="token punctuation">;</span>
spec:
 ingressClassName: nginx <span class="token comment"># 指定该 Ingress 被哪个 Controller 解析</span>
 tls:
 - hosts:
   - dujie.test.com
   secretName: ca-secret
 rules: <span class="token comment"># 定义路由匹配规则，可以配置多个</span>
 - host: dujie.test.com <span class="token comment"># 定义域名</span>
   http: <span class="token comment"># </span>
     paths: <span class="token comment"># 详细的路由配置，可以配置多个</span>
     - backend: <span class="token comment"># 指定该路由的后端</span>
         service:
           name: nginx
           port:
             number: <span class="token number">80</span>
       path: / <span class="token comment"># 指定 PATH</span>
       pathType: ImplementationSpecific <span class="token comment"># 指定匹配规则</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>


<p>登录到 ingress-nginx 的 Pod 查看配置：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">root@VM-26-130-ubuntu:/usr/local/src/k8s/ingress<span class="token comment"># kubectl get pods -n ingress-nginx </span>
NAME                                      READY   STATUS      RESTARTS   AGE
ingress-nginx-admission-create--1-5c74h   <span class="token number">0</span>/1     Completed   <span class="token number">0</span>          110m
ingress-nginx-admission-patch--1-gs92r    <span class="token number">0</span>/1     Completed   <span class="token number">0</span>          110m
ingress-nginx-controller-4frtd            <span class="token number">1</span>/1     Running     <span class="token number">0</span>          110m
ingress-nginx-controller-sgcg2            <span class="token number">1</span>/1     Running     <span class="token number">0</span>          110m
ingress-nginx-controller-tpndn            <span class="token number">1</span>/1     Running     <span class="token number">0</span>          110m
root@VM-26-130-ubuntu:/usr/local/src/k8s/ingress<span class="token comment"># kubectl exec -it -n ingress-nginx  ingress-nginx-controller-4frtd  bash </span>
kubectl <span class="token builtin class-name">exec</span> <span class="token punctuation">[</span>POD<span class="token punctuation">]</span> <span class="token punctuation">[</span>COMMAND<span class="token punctuation">]</span> is DEPRECATED and will be removed <span class="token keyword">in</span> a future version. Use kubectl <span class="token builtin class-name">exec</span> <span class="token punctuation">[</span>POD<span class="token punctuation">]</span> -- <span class="token punctuation">[</span>COMMAND<span class="token punctuation">]</span> instead.
VM-26-136-ubuntu:/etc/nginx$ <span class="token function">cat</span> nginx.conf  <span class="token operator">|</span><span class="token function">grep</span> Upgrade
                        proxy_set_header                        Upgrade           <span class="token variable">$http_upgrade</span><span class="token punctuation">;</span>
                        proxy_set_header                        Upgrade           <span class="token variable">$http_upgrade</span><span class="token punctuation">;</span>
VM-26-136-ubuntu:/etc/nginx$ <span class="token function">cat</span> nginx.conf  <span class="token operator">|</span><span class="token function">grep</span> connection_upgrade
        map <span class="token variable">$http_upgrade</span> <span class="token variable">$connection_upgrade</span> <span class="token punctuation">&#123;</span>
                        proxy_set_header                        Connection        <span class="token variable">$connection_upgrade</span><span class="token punctuation">;</span>
                        proxy_set_header                        Connection        <span class="token variable">$connection_upgrade</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h6 id="2-3-5-域名重定向Redirect"><a href="#2-3-5-域名重定向Redirect" class="headerlink" title="2.3.5 域名重定向Redirect"></a>2.3.5 域名重定向Redirect</h6><p>在使用 Nginx 作为代理服务器时，Redirect 可用于域名的重定向，比如访问 old.com 被重定向到 new.com。Ingress 也可以实现 Redirect 功能，接下来用 nginx.redirect.com 作为旧域名，baidu.com 作为新域名进行演示：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">root@VM-26-130-ubuntu:/usr/local/src/k8s/ingress<span class="token comment"># cat redirect-ingress.yaml </span>
apiVersion: networking.k8s.io/v1 <span class="token comment"># k8s >= 1.22 必须 v1</span>
kind: Ingress
metadata:
 name: nginx-ingress
 namespace: study-ingress
 annotations:
   nginx.ingress.kubernetes.io/permanent-redirect: https://www.baidu.com
   nginx.ingress.kubernetes.io/permanent-redirect-code: <span class="token string">"308"</span>
spec:
 ingressClassName: nginx <span class="token comment"># 指定该 Ingress 被哪个 Controller 解析</span>
 tls:
 - hosts:
   - dujie.test.com
   secretName: ca-secret
 rules: <span class="token comment"># 定义路由匹配规则，可以配置多个</span>
 - host: dujie.test.com <span class="token comment"># 定义域名</span>
   http: <span class="token comment"># </span>
     paths: <span class="token comment"># 详细的路由配置，可以配置多个</span>
     - backend: <span class="token comment"># 指定该路由的后端</span>
         service:
           name: nginx
           port:
             number: <span class="token number">80</span>
       path: / <span class="token comment"># 指定 PATH</span>
       pathType: ImplementationSpecific <span class="token comment"># 指定匹配规则</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>


<p>使用 curl 访问域名 nginx.redirect.com，可以看到 308（使用浏览器会自动跳转到百度的首页）：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">root@VM-26-130-ubuntu:/usr/local/src/k8s/ingress<span class="token comment"># curl dujie.test.com -I</span>
HTTP/1.1 <span class="token number">308</span> Permanent Redirect
Date: Tue, <span class="token number">25</span> Mar <span class="token number">2025</span> 08:15:28 GMT
Content-Type: text/html
Content-Length: <span class="token number">164</span>
Connection: keep-alive
Location: https://www.baidu.com<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h6 id="2-3-6-访问地址重写Rewrite"><a href="#2-3-6-访问地址重写Rewrite" class="headerlink" title="2.3.6 访问地址重写Rewrite"></a>2.3.6 访问地址重写Rewrite</h6><p>创建一个应用模拟后端服务</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">root@VM-26-130-ubuntu:/usr/local/src/k8s/ingress<span class="token comment"># kubectl create deploy backend-api --image=registry.cn-beijing.aliyuncs.com/dotbalo/nginx:backend-api -n study-ingress</span>
deployment.apps/backend-api created<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p>创建service暴露应用</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">root@VM-26-130-ubuntu:/usr/local/src/k8s/ingress<span class="token comment"># kubectl expose  deploy -n  study-ingress  backend-api  --port 80</span>
service/backend-api exposed<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p>查看service地址，并且通过&#x2F;api-a访问测试</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">root@VM-26-130-ubuntu:/usr/local/src/k8s/ingress<span class="token comment"># kubectl get svc -n study-ingress </span>
NAME          TYPE        CLUSTER-IP     EXTERNAL-IP   PORT<span class="token punctuation">(</span>S<span class="token punctuation">)</span>   AGE
backend-api   ClusterIP   <span class="token number">10.16</span>.252.90   <span class="token operator">&lt;</span>none<span class="token operator">></span>        <span class="token number">80</span>/TCP    7s
nginx         ClusterIP   <span class="token number">10.16</span>.238.11   <span class="token operator">&lt;</span>none<span class="token operator">></span>        <span class="token number">80</span>/TCP    69m

root@VM-26-130-ubuntu:/usr/local/src/k8s/ingress<span class="token comment"># curl 10.16.252.90</span>
<span class="token operator">&lt;</span>h<span class="token operator"><span class="token file-descriptor important">1</span>></span> backend <span class="token keyword">for</span> ingress rewrite <span class="token operator">&lt;</span>/h<span class="token operator"><span class="token file-descriptor important">1</span>></span>

<span class="token operator">&lt;</span>h<span class="token operator"><span class="token file-descriptor important">2</span>></span> Path: /api-a <span class="token operator">&lt;</span>/h<span class="token operator"><span class="token file-descriptor important">2</span>></span>


<span class="token operator">&lt;</span>a <span class="token assign-left variable">href</span><span class="token operator">=</span><span class="token string">"http://gaoxin.kubeasy.com"</span><span class="token operator">></span> Kubeasy <span class="token operator">&lt;</span>/a<span class="token operator">></span>
root@VM-26-130-ubuntu:/usr/local/src/k8s/ingress<span class="token comment"># </span>
root@VM-26-130-ubuntu:/usr/local/src/k8s/ingress<span class="token comment"># curl 10.16.252.90/api-a</span>
<span class="token operator">&lt;</span>html<span class="token operator">></span>
<span class="token operator">&lt;</span>head<span class="token operator">></span><span class="token operator">&lt;</span>title<span class="token operator">></span><span class="token number">404</span> Not Found<span class="token operator">&lt;</span>/title<span class="token operator">></span><span class="token operator">&lt;</span>/head<span class="token operator">></span>
<span class="token operator">&lt;</span>body<span class="token operator">></span>
<span class="token operator">&lt;</span>center<span class="token operator">></span><span class="token operator">&lt;</span>h<span class="token operator"><span class="token file-descriptor important">1</span>></span><span class="token number">404</span> Not Found<span class="token operator">&lt;</span>/h<span class="token operator"><span class="token file-descriptor important">1</span>></span><span class="token operator">&lt;</span>/center<span class="token operator">></span>
<span class="token operator">&lt;</span>hr<span class="token operator">></span><span class="token operator">&lt;</span>center<span class="token operator">></span>nginx/1.15.1<span class="token operator"><span class="token file-descriptor important">2</span>&lt;</span>/center<span class="token operator">></span>
<span class="token operator">&lt;</span>/body<span class="token operator">></span>
<span class="token operator">&lt;</span>/html<span class="token operator">></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>配置 Ingress，假设需要配置一个&#x2F;api-a 代理到该服务：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
 name: backend-api
 namespace: study-ingress
spec:
 ingressClassName: nginx
 rules:
 - host: nginx.rewrite.com
   http:
     paths:
     - backend:
         service:
           name: backend-api
           port:
             number: <span class="token number">80</span>
       path: /api-a
       pathType: ImplementationSpecific<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>测试通过浏览器访问，会报 404：</p>
<p><img src="/images/ZFKnLkLRhM9bAvoePvnu2bL9qyAKfJV3G0bIP5dBxF4.png" alt="image"></p>
<p>此时需要通过 Ingress Nginx 的 Rewrite 功能，将&#x2F;api-a 重写为“&#x2F;”，配置示例如下：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
 name: backend-api
 namespace: study-ingress
 annotations:
   nginx.ingress.kubernetes.io/rewrite-target: /<span class="token variable">$2</span>
spec:
 ingressClassName: nginx
 rules:
 - host: nginx.rewrite.com
   http:
     paths:
     - backend:
         service:
           name: backend-api
           port:
             number: <span class="token number">80</span>
       path: /api-a<span class="token punctuation">(</span>/<span class="token operator">|</span>$<span class="token punctuation">)</span><span class="token punctuation">(</span>.*<span class="token punctuation">)</span>
       pathType: ImplementationSpecific<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>再次访问 nginx.test.com&#x2F;api-a 即可访问到后端服务：</p>
<p><img src="/images/6VPKQLpZsBxbWvG1Y7D94AxBDHha1mroVILwxo7uAa8.png" alt="image"></p>
<h6 id="2-3-7-访问速率限制"><a href="#2-3-7-访问速率限制" class="headerlink" title="2.3.7 访问速率限制"></a>2.3.7 访问速率限制</h6><p>有时候可能需要限制速率以降低后端压力，或者限制单个 IP 每秒的访问速率防止攻击。此时可以使用 Nginx 的 rate limit 进行配置。</p>
<p>首先没有加速率限制，使用 ab 进行访问，Failed 为 0：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">root@VM-26-130-ubuntu:/usr/local/src/k8s/ingress<span class="token comment"># ab -c 10 -n 100 http://dujie.test.com/ |grep requests</span>
Complete requests:      <span class="token number">100</span>
Failed requests:        <span class="token number">0</span>
Time per request:       <span class="token number">0.061</span> <span class="token punctuation">[</span>ms<span class="token punctuation">]</span> <span class="token punctuation">(</span>mean, across all concurrent requests<span class="token punctuation">)</span>
Percentage of the requests served within a certain <span class="token function">time</span> <span class="token punctuation">(</span>ms<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>添加速率限制，限制只能有一个连接，只需要添加<code>nginx.ingress.kubernetes.io/limitconnections</code>为 1 即可：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">root@VM-26-130-ubuntu:/usr/local/src/k8s/ingress<span class="token comment"># cat web-ingress.yaml </span>
apiVersion: networking.k8s.io/v1 <span class="token comment"># k8s >= 1.22 必须 v1</span>
kind: Ingress
metadata:
 name: nginx-ingress
 namespace: study-ingress
 annotations:
   nginx.ingress.kubernetes.io/limit-connections: <span class="token string">"1"</span>
spec:
 ingressClassName: nginx <span class="token comment"># 指定该 Ingress 被哪个 Controller 解析</span>
 rules: <span class="token comment"># 定义路由匹配规则，可以配置多个</span>
 - host: dujie.test.com <span class="token comment"># 定义域名</span>
   http: <span class="token comment"># </span>
     paths: <span class="token comment"># 详细的路由配置，可以配置多个</span>
     - backend: <span class="token comment"># 指定该路由的后端</span>
         service:
           name: nginx
           port:
             number: <span class="token number">80</span>
       path: / <span class="token comment"># 指定 PATH</span>
       pathType: ImplementationSpecific <span class="token comment"># 指定匹配规则</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>再次使用 ab 测试，</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">root@VM-26-130-ubuntu:/usr/local/src/k8s/ingress<span class="token comment"># ab -c 10 -n 100 http://dujie.test.com/ |grep requests</span>
Complete requests:      <span class="token number">100</span>
Failed requests:        <span class="token number">13</span>
Time per request:       <span class="token number">0.065</span> <span class="token punctuation">[</span>ms<span class="token punctuation">]</span> <span class="token punctuation">(</span>mean, across all concurrent requests<span class="token punctuation">)</span>
Percentage of the requests served within a certain <span class="token function">time</span> <span class="token punctuation">(</span>ms<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>还有很多其它方面的限制，常用的配置如下：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment">#限制每秒的连接，单个 IP：</span>
nginx.ingress.kubernetes.io/limit-rps
<span class="token comment">#限制每分钟的连接，单个 IP：</span>
nginx.ingress.kubernetes.io/limit-rpm
<span class="token comment">#限制客户端每秒传输的字节数，单位为 K，需要开启 proxy-buffering：</span>
nginx.ingress.kubernetes.io/limit-rate
<span class="token comment"># 速率限制白名单</span>
nginx.ingress.kubernetes.io/limit-whitelist<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h6 id="2-3-8-IngressNginx-黑-x2F-白名单"><a href="#2-3-8-IngressNginx-黑-x2F-白名单" class="headerlink" title="2.3.8 IngressNginx 黑&#x2F;白名单"></a>2.3.8 IngressNginx 黑&#x2F;白名单</h6><p>####### 2.3.8.1 配置黑名单<br>使用 nginx.ingress.kubernetes.io&#x2F;denylist-source-range 添加黑名单，支持 IP、网段，多个黑名单逗号分隔：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">root@VM-26-130-ubuntu:/usr/local/src/k8s/ingress<span class="token comment"># cat ingress-with-auth.yaml </span>
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
 annotations:
   nginx.ingress.kubernetes.io/denylist-source-range: <span class="token number">10.122</span>.26.134
<span class="token comment">#10.0.0.0/24,172.10.0.1</span>
 name: ingress-with-auth
 namespace: study-ingress
spec:
 ingressClassName: nginx
 rules:
 - host: auth.test.com
   http:
     paths:
     - backend:
         service:
           name: nginx
           port:
             number: <span class="token number">80</span>
       path: /
       pathType: ImplementationSpecific<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>


<p>访问 auth.test.com 会被拒绝：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">root@VM-26-134-ubuntu:~<span class="token comment"># curl -H "Host:auth.test.com" 10.122.26.134</span>
<span class="token operator">&lt;</span>html<span class="token operator">></span>
<span class="token operator">&lt;</span>head<span class="token operator">></span><span class="token operator">&lt;</span>title<span class="token operator">></span><span class="token number">403</span> Forbidden<span class="token operator">&lt;</span>/title<span class="token operator">></span><span class="token operator">&lt;</span>/head<span class="token operator">></span>
<span class="token operator">&lt;</span>body<span class="token operator">></span>
<span class="token operator">&lt;</span>center<span class="token operator">></span><span class="token operator">&lt;</span>h<span class="token operator"><span class="token file-descriptor important">1</span>></span><span class="token number">403</span> Forbidden<span class="token operator">&lt;</span>/h<span class="token operator"><span class="token file-descriptor important">1</span>></span><span class="token operator">&lt;</span>/center<span class="token operator">></span>
<span class="token operator">&lt;</span>hr<span class="token operator">></span><span class="token operator">&lt;</span>center<span class="token operator">></span>nginx<span class="token operator">&lt;</span>/center<span class="token operator">></span>
<span class="token operator">&lt;</span>/body<span class="token operator">></span>
<span class="token operator">&lt;</span>/html<span class="token operator">></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>


<p>访问其他域名正常：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">root@VM-26-134-ubuntu:~<span class="token comment"># curl -I dujie.test.com </span>
HTTP/1.1 <span class="token number">200</span> OK
Date: Tue, <span class="token number">25</span> Mar <span class="token number">2025</span> 08:57:48 GMT
Content-Type: text/html
Content-Length: <span class="token number">612</span>
Connection: keep-alive
Last-Modified: Tue, <span class="token number">16</span> Apr <span class="token number">2019</span> <span class="token number">13</span>:08:19 GMT
ETag: <span class="token string">"5cb5d3c3-264"</span>
Accept-Ranges: bytes
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>####### 2.3.8.2 配置白名单<br>白名单表示只允许某个 IP 可以访问，直接在 yaml 文件中配置即可，比如只允许192.168.181.141 访问，只需要添加一个 nginx.ingress.kubernetes.io&#x2F;whitelist-source-range 注释即可：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
 annotations:
   nginx.ingress.kubernetes.io/whitelist-source-range: <span class="token number">10.122</span>.26.134
 name: ingress-with-auth
 namespace: study-ingress
spec:
 ingressClassName: nginx
 rules:
 - host: auth.test.com
   http:
     paths:
     - backend:
         service:
           name: nginx
           port:
             number: <span class="token number">80</span>
       path: /
       pathType: ImplementationSpecific<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>####### 2.3.8.2 全局黑白名单</p>
<p>Ingress-nginx 支持全局的黑白名单（白名单慎用），只需要在 ingress nginx 的配置文件中添加即可，添加后无需重启 Controller，加一个全局黑名单：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">root@VM-26-130-ubuntu:/usr/local/src/k8s/ingress<span class="token comment"># kubectl edit cm -n ingress-nginx  ingress-nginx-controller </span>

<span class="token comment"># Please edit the object below. Lines beginning with a '#' will be ignored,</span>
<span class="token comment"># and an empty file will abort the edit. If an error occurs while saving this file will be</span>
<span class="token comment"># reopened with the relevant failures.</span>
<span class="token comment">#</span>
apiVersion: v1
data:
  allow-snippet-annotations: <span class="token string">"true"</span>
  denylist-source-range: <span class="token number">10.122</span>.26.134
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>配置全局黑名单后，访问任何域名都会被拒绝：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># curl -H "Host:nginx.test.com" https://10.122.26.134 -k</span>
<span class="token operator">&lt;</span>html<span class="token operator">></span>
<span class="token operator">&lt;</span>head<span class="token operator">></span><span class="token operator">&lt;</span>title<span class="token operator">></span><span class="token number">403</span> Forbidden<span class="token operator">&lt;</span>/title<span class="token operator">></span><span class="token operator">&lt;</span>/head<span class="token operator">></span>
<span class="token comment"># curl -H "Host:auth.test.com" https://10.122.26.134 -k</span>
<span class="token operator">&lt;</span>html<span class="token operator">></span>
<span class="token operator">&lt;</span>head<span class="token operator">></span><span class="token operator">&lt;</span>title<span class="token operator">></span><span class="token number">403</span> Forbidden<span class="token operator">&lt;</span>/title<span class="token operator">></span><span class="token operator">&lt;</span>/head<span class="token operator">></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>添加一个全局白名单：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># kubectl edit cm ingress-nginx-controller -n ingress-nginx</span>
data:
  allow-snippet-annotations: <span class="token string">"true"</span>
  whitelist-source-range: <span class="token number">10.122</span>.26.134<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<p>添加后除了 192.168.181.134，任何 IP 都不能访问该 Ingress Controller 下的域名：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># curl -H "Host:auth.test.com" https://10.122.26.134 -k</span>
<span class="token comment"># 10.122.26.134 正常</span>
<span class="token operator">&lt;</span>head<span class="token operator">></span><span class="token operator">&lt;</span>title<span class="token operator">></span><span class="token number">401</span> Authorization Required<span class="token operator">&lt;</span>/title<span class="token operator">></span><span class="token operator">&lt;</span>/head<span class="token operator">></span>
<span class="token comment"># 其他节点均拒绝</span>
<span class="token comment"># curl -H "Host:auth.test.com" https://10.122.26.134 -k</span>
<span class="token operator">&lt;</span>html<span class="token operator">></span>
<span class="token operator">&lt;</span>head<span class="token operator">></span><span class="token operator">&lt;</span>title<span class="token operator">></span><span class="token number">403</span> Forbidden<span class="token operator">&lt;</span>/title<span class="token operator">></span><span class="token operator">&lt;</span>/head<span class="token operator">></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h6 id="2-3-9-自定义错误页"><a href="#2-3-9-自定义错误页" class="headerlink" title="2.3.9 自定义错误页"></a>2.3.9 自定义错误页</h6><p>官方文档：<a target="_blank" rel="noopener" href="https://kubernetes.github.io/ingress-nginx/examples/customization/custom-errors/">https://kubernetes.github.io/ingress-nginx/examples/customization/custom-errors/</a></p>
<p>每个项目在对外发布时，难免不了会有一些未知的错误，比如 404&#x2F;502&#x2F;503 等，为了给客户更加友好的提示，可以使用 default backend 自定义错误页。</p>
<p>首先需要安装 default backend 服务：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">root@VM-26-130-ubuntu:/usr/local/src/k8s/ingress<span class="token comment"># cat custom-default-backend.yaml </span>
---
apiVersion: v1
kind: Service
metadata:
  name: nginx-errors
  labels:
    app.kubernetes.io/name: nginx-errors
    app.kubernetes.io/part-of: ingress-nginx
spec:
  selector:
    app.kubernetes.io/name: nginx-errors
    app.kubernetes.io/part-of: ingress-nginx
  ports:
  - port: <span class="token number">80</span>
    targetPort: <span class="token number">8080</span>
    name: http
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: nginx-errors
  labels:
    app.kubernetes.io/name: nginx-errors
    app.kubernetes.io/part-of: ingress-nginx
spec:
  replicas: <span class="token number">1</span>
  selector:
    matchLabels:
      app.kubernetes.io/name: nginx-errors
      app.kubernetes.io/part-of: ingress-nginx
  template:
    metadata:
      labels:
        app.kubernetes.io/name: nginx-errors
        app.kubernetes.io/part-of: ingress-nginx
    spec:
      containers:
      - name: nginx-error-server
        image: registry.cn-beijing.aliyuncs.com/dotbalo/custom-error-pages:v1.0.1 
        ports:
        - containerPort: <span class="token number">8080</span>
        <span class="token comment"># Setting the environment variable DEBUG we can see the headers sent </span>
        <span class="token comment"># by the ingress controller to the backend in the client response.</span>
        <span class="token comment"># env:</span>
        <span class="token comment"># - name: DEBUG</span>
        <span class="token comment">#   value: "true"</span>

        <span class="token comment"># Mounting custom error page from configMap</span>
        <span class="token comment"># volumeMounts:</span>
        <span class="token comment"># - name: custom_error_pages</span>
        <span class="token comment">#   mountPath: /www</span>

      <span class="token comment"># Mounting custom error page from configMap</span>
      <span class="token comment"># volumes:</span>
      <span class="token comment"># - name: custom_error_pages</span>
      <span class="token comment">#   configMap:</span>
      <span class="token comment">#     name: custom_error_pages</span>
      <span class="token comment">#     items:</span>
      <span class="token comment">#     - key: "404"</span>
      <span class="token comment">#       path: "404.html"</span>
      <span class="token comment">#     - key: "503"</span>
      <span class="token comment">#       path: "503.html"</span>


root@VM-26-130-ubuntu:/usr/local/src/k8s/ingress<span class="token comment"># kubectl apply -f custom-default-backend.yaml  -n ingress-nginx </span>
service/nginx-errors created
deployment.apps/nginx-errors created
root@VM-26-130-ubuntu:/usr/local/src/k8s/ingress<span class="token comment"># kubectl get pods -n ingress-nginx </span>
NAME                                      READY   STATUS      RESTARTS   AGE
ingress-nginx-admission-create--1-5c74h   <span class="token number">0</span>/1     Completed   <span class="token number">0</span>          23h
ingress-nginx-admission-patch--1-gs92r    <span class="token number">0</span>/1     Completed   <span class="token number">0</span>          23h
ingress-nginx-controller-4frtd            <span class="token number">1</span>/1     Running     <span class="token number">0</span>          23h
ingress-nginx-controller-sgcg2            <span class="token number">1</span>/1     Running     <span class="token number">0</span>          23h
ingress-nginx-controller-tpndn            <span class="token number">1</span>/1     Running     <span class="token number">0</span>          23h
nginx-errors-6bf9bfd77f-54mpc             <span class="token number">1</span>/1     Running     <span class="token number">0</span>          9s<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>更改ingress-nginx的启动参数，支持自定义错误页</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">root@VM-26-130-ubuntu:/usr/local/src/k8s/ingress<span class="token comment"># kubectl edit ds -n ingress-nginx  </span>
daemonset.apps/ingress-nginx-controller edited<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p><img src="/images/lGdieMx4S-O5F2bSP2J7BVkdEMAGdNbdhFo3bQ9v6ks.png" alt="image"></p>
<p>配置 ConfigMap，定义哪些错误码被重定向到自定义错误页：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">root@VM-26-130-ubuntu:/usr/local/src/k8s/ingress<span class="token comment"># kubectl edit cm -n ingress-nginx  ingress-nginx-controller </span>
apiVersion: v1
data:
  allow-snippet-annotations: <span class="token string">"true"</span>
  custom-http-errors: <span class="token number">404,502</span>,503
  denylist-source-range: <span class="token number">10.122</span>.26.134<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>更新完成以后访问一个不存在的页面，比如之前定义的 nginx.test.com。访问一个不存在的页面 123，就会返回 Error Server 中的页面：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">root@VM-26-130-ubuntu:/usr/local/src/k8s/ingress<span class="token comment"># curl dujie.test.com/asdasd</span>
<span class="token operator">&lt;</span>span<span class="token operator">></span>The page you're looking <span class="token keyword">for</span> could not be found.<span class="token operator">&lt;</span>/span<span class="token operator">></span>root@VM-26-130-ubuntu:/usr/local/src/k8s/ingress<span class="token comment"># </span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<h6 id="2-3-10-匹配请求头区分不同客户端"><a href="#2-3-10-匹配请求头区分不同客户端" class="headerlink" title="2.3.10 匹配请求头区分不同客户端"></a>2.3.10 匹配请求头区分不同客户端</h6><p>首先部署移动端应用：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">root@VM-26-130-ubuntu:/usr/local/src/k8s/ingress<span class="token comment"># kubectl create deploy phone --image=registry.cn-beijing.aliyuncs.com/dotbalo/nginx:phone -n study-ingress</span>
deployment.apps/phone created
root@VM-26-130-ubuntu:/usr/local/src/k8s/ingress<span class="token comment"># kubectl expose deploy phone --port 80 -n study-ingress</span>
service/phone exposed<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<p>部署电脑端应用：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">root@VM-26-130-ubuntu:/usr/local/src/k8s/ingress<span class="token comment">#  kubectl create deploy laptop --image=registry.cn-beijing.aliyuncs.com/dotbalo/nginx:laptop -n study-ingress</span>
deployment.apps/laptop created
root@VM-26-130-ubuntu:/usr/local/src/k8s/ingress<span class="token comment"># kubectl expose deploy laptop --port 80 -n study-ingress</span>
service/laptop exposed
root@VM-26-130-ubuntu:/usr/local/src/k8s/ingress<span class="token comment"># kubectl get pods -n study-ingress  -l app=laptop</span>
NAME                      READY   STATUS    RESTARTS   AGE
laptop-664b565969-n4mpl   <span class="token number">1</span>/1     Running   <span class="token number">0</span>          18s<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>之后创建电脑端的 Ingress，注意 <code>Ingress annotations </code>的 <code>nginx.ingress.kubernetes.io/server-snippet </code>配置。Snippet 配置是专门用于一些复杂的 Nginx 配置，和 Nginx 配置通用。匹配移动端实例如下：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
 annotations:
   nginx.ingress.kubernetes.io/server-snippet: <span class="token operator">|</span>
     <span class="token builtin class-name">set</span> <span class="token variable">$agentflag</span> <span class="token number">0</span><span class="token punctuation">;</span>
     <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$http_user_agent</span> ~* <span class="token string">"(Android|iPhone|Windows Phone|UC|Kindle)"</span> <span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
     <span class="token builtin class-name">set</span> <span class="token variable">$agentflag</span> <span class="token number">1</span><span class="token punctuation">;</span>
     <span class="token punctuation">&#125;</span>
     <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token variable">$agentflag</span> <span class="token operator">=</span> <span class="token number">1</span> <span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token builtin class-name">return</span> <span class="token number">301</span> http://phone.test.com<span class="token punctuation">;</span>
     <span class="token punctuation">&#125;</span>
 name: laptop
 namespace: study-ingress
spec:
 ingressClassName: nginx
 rules:
 - host: test.com
   http:
     paths:
     - backend:
         service:
           name: laptop
           port:
             number: <span class="token number">80</span>
       path: /
       pathType: ImplementationSpecific<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>首先通过浏览器访问 test.com，可以看到页面是 Laptop：</p>
<p><img src="/images/gMNHPfxiF7M28dTQVSc-oXZmllr0aOhCiTGVtXeF6VU.png" alt="image"></p>
<p>接下来使用浏览器的开发者工具将终端类型改为 iPhone，或者直接用 iPhone 手机访问（线上业务一般配置的都有 DNS，可以直接解析域名，测试环境可能需要自己单独配置），如下图所示：</p>
<p><img src="/images/KRow4ZnmYePu0AVfSls7FKiV4MxVXeMXI1hLIbQU_i0.png" alt="image"></p>
<h6 id="2-3-11-灰度-x2F-金丝雀-x2F-蓝绿发布"><a href="#2-3-11-灰度-x2F-金丝雀-x2F-蓝绿发布" class="headerlink" title="2.3.11 灰度&#x2F;金丝雀&#x2F;蓝绿发布"></a>2.3.11 灰度&#x2F;金丝雀&#x2F;蓝绿发布</h6><p>####### 2.3.11.1 创建v1版本<br>首先创建模拟 Production（生产）环境的 Namespace 和服务：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">root@VM-26-130-ubuntu:/usr/local/src/k8s/ingress<span class="token comment"># kubectl create ns production</span>
namespace/production created
root@VM-26-130-ubuntu:/usr/local/src/k8s/ingress<span class="token comment"># </span>
root@VM-26-130-ubuntu:/usr/local/src/k8s/ingress<span class="token comment"># kubectl create deploy canary-v1 --image=registry.cn-beijing.aliyuncs.com/dotbalo/canary:v1 -n production</span>
deployment.apps/canary-v1 created
root@VM-26-130-ubuntu:/usr/local/src/k8s/ingress<span class="token comment"># kubectl expose deploy canary-v1 -n production  --port 8080</span>
service/canary-v1 exposed
root@VM-26-130-ubuntu:/usr/local/src/k8s/ingress<span class="token comment"># </span>
root@VM-26-130-ubuntu:/usr/local/src/k8s/ingress<span class="token comment"># kubectl get pods -n production </span>
NAME                         READY   STATUS    RESTARTS   AGE
canary-v1-64b9cdfd5d-zjtgh   <span class="token number">1</span>/1     Running   <span class="token number">0</span>          22s<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>创建V1的ingress</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">root@VM-26-130-ubuntu:/usr/local/src/k8s/ingress<span class="token comment"># cat canary-v1-ingress.yaml </span>
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
 name: canary-v1
 namespace: production
spec:
 ingressClassName: nginx
 rules:
 - host: canary.com
   http:
     paths:
     - backend:
         service:
           name: canary-v1
           port:
             number: <span class="token number">8080</span>
       path: /
       pathType: Prefix<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>使用浏览器访问该服务，可以看到 Canary v1 的页面：</p>
<p><img src="/images/7h7YQC5BGqRQ5tnd2w2q4qB-rXlObPfo4wfdXWS3BRo.png" alt="image"></p>
<p>####### 2.3.11.2 创建v2版本<br>下面创建v2版本，充当灰度环境</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">root@VM-26-130-ubuntu:/usr/local/src/k8s/ingress<span class="token comment"># kubectl create ns canary</span>
namespace/canary created
root@VM-26-130-ubuntu:/usr/local/src/k8s/ingress<span class="token comment">#  kubectl create deploy canary-v2 --image=registry.cn-beijing.aliyuncs.com/dotbalo/canary:v2 -n canary</span>
deployment.apps/canary-v2 created
root@VM-26-130-ubuntu:/usr/local/src/k8s/ingress<span class="token comment"># </span>
root@VM-26-130-ubuntu:/usr/local/src/k8s/ingress<span class="token comment">#  kubectl expose deploy canary-v2 --port 8080 -n canary</span>
service/canary-v2 exposed<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>


<p>待程序启动完成后，通过 Service 访问该服务，会返回 Canary v2：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">root@VM-26-130-ubuntu:/usr/local/src/k8s/ingress<span class="token comment"># kubectl get svc -n canary </span>
NAME        TYPE        CLUSTER-IP    EXTERNAL-IP   PORT<span class="token punctuation">(</span>S<span class="token punctuation">)</span>    AGE
canary-v2   ClusterIP   <span class="token number">10.16</span>.245.1   <span class="token operator">&lt;</span>none<span class="token operator">></span>        <span class="token number">8080</span>/TCP   23s
root@VM-26-130-ubuntu:/usr/local/src/k8s/ingress<span class="token comment"># curl 10.16.245.1:8080</span>
<span class="token operator">&lt;</span>h<span class="token operator"><span class="token file-descriptor important">1</span>></span>Canary v<span class="token operator"><span class="token file-descriptor important">2</span>&lt;</span>/h<span class="token operator"><span class="token file-descriptor important">1</span>></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>接下来通过 Ingress 控制流量，实现逐步把流量切入到新版本。</p>
<p>####### 2.3.11.3 Canary版本切入部分流量<br>创建 v2 版本的 Ingress 时，需要添加两个注释，一个是 nginx.ingress.kubernetes.io&#x2F;canary，表明是灰度环境，nginx.ingress.kubernetes.io&#x2F;canary-weight 表明切多少流量到该环境，本示例为10%：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">root@VM-26-130-ubuntu:/usr/local/src/k8s/ingress<span class="token comment"># cat canary-v2-ingress.yaml </span>
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
 annotations:
   nginx.ingress.kubernetes.io/canary: <span class="token string">"true"</span>
   nginx.ingress.kubernetes.io/canary-weight: <span class="token string">"10"</span>
 name: canary-v2
 namespace: canary
spec:
 ingressClassName: nginx
 rules:
 - host: canary.com
   http:
     paths:
     - backend:
         service:
           name: canary-v2
           port:
             number: <span class="token number">8080</span>
       path: /
       pathType: ImplementationSpecific<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>此时通过 nginx.ingress.kubernetes.io&#x2F;canary-weight: “10”设置的权重是 10，即 v1:v2 为 9:1。</p>
<p>再次访问可以看到页面会来回显示 v1 和 v2：</p>
<p>####### 2.3.11.4 测试灰度发布<br>接下来使用 Ruby 脚本进行测试，此脚本会输出 v1 和 v2 的访问次数比值：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">root@VM-26-130-ubuntu:/usr/local/src/k8s/ingress<span class="token comment"># cat test-canary.rb </span>
counts <span class="token operator">=</span> Hash.new<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>

<span class="token number">100</span>.times <span class="token keyword">do</span>
   output <span class="token operator">=</span> <span class="token variable"><span class="token variable">`</span><span class="token function">curl</span> -s canary.com <span class="token operator">|</span> <span class="token function">grep</span> <span class="token string">'Canary'</span> <span class="token operator">|</span> <span class="token function">awk</span> <span class="token string">'&#123;print $2&#125;'</span> <span class="token operator">|</span> <span class="token function">awk</span> -F<span class="token string">"&lt;"</span> <span class="token string">'&#123;print $1&#125;'</span><span class="token variable">`</span></span>
   counts<span class="token punctuation">[</span>output.strip.split.last<span class="token punctuation">]</span> <span class="token operator">+=</span> <span class="token number">1</span>
 end

puts counts
root@VM-26-130-ubuntu:/usr/local/src/k8s/ingress<span class="token comment"># apt install ruby</span>

root@VM-26-130-ubuntu:/usr/local/src/k8s/ingress<span class="token comment"># ruby test-canary.rb </span>
<span class="token punctuation">&#123;</span><span class="token string">"v1"</span><span class="token operator">=</span><span class="token operator">></span><span class="token number">87</span>, <span class="token string">"v2"</span><span class="token operator">=</span><span class="token operator">></span><span class="token number">13</span><span class="token punctuation">&#125;</span>
root@VM-26-130-ubuntu:/usr/local/src/k8s/ingress<span class="token comment"># </span>
root@VM-26-130-ubuntu:/usr/local/src/k8s/ingress<span class="token comment"># ruby test-canary.rb </span>
<span class="token punctuation">&#123;</span><span class="token string">"v1"</span><span class="token operator">=</span><span class="token operator">></span><span class="token number">92</span>, <span class="token string">"v2"</span><span class="token operator">=</span><span class="token operator">></span><span class="token number">8</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h6 id="2-3-12-Ingress常见报错排查"><a href="#2-3-12-Ingress常见报错排查" class="headerlink" title="2.3.12 Ingress常见报错排查"></a>2.3.12 Ingress常见报错排查</h6><h6 id="2-3-12-1-404（Not-Found）报错"><a href="#2-3-12-1-404（Not-Found）报错" class="headerlink" title="2.3.12.1 404（Not Found）报错"></a>2.3.12.1 404（Not Found）报错</h6><p>404 表示访问的路由不存在。通常问题如下：</p>
<ul>
<li>ingress 路径配置的不正确</li>
<li>ingress的配置未被Controller解析</li>
<li>未使用正确的域名和路径访问</li>
<li>代理的服务没有该路径</li>
</ul>
<p>场景分析：有一个项目包含一个前端，两个后端，域名为project.test.com。</p>
<p>其中路径 &#x2F; 指向前端</p>
<p>路径&#x2F;userapi 指向user服务</p>
<p>路径paymentapi指向payment服务</p>
<p>部署服务：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">root@VM-26-130-ubuntu:/usr/local/src/k8s/ingress<span class="token comment"># kubectl create deploy user --image=registry.cn-beijing.aliyuncs.com/dotbalo/ingress-err:v1 -n study-ingress</span>
deployment.apps/user created
root@VM-26-130-ubuntu:/usr/local/src/k8s/ingress<span class="token comment"># kubectl create deploy payment --image=registry.cn-beijing.aliyuncs.com/dotbalo/ingress-err:v1 -n study-ingress</span>
deployment.apps/payment created
root@VM-26-130-ubuntu:/usr/local/src/k8s/ingress<span class="token comment"># </span>
root@VM-26-130-ubuntu:/usr/local/src/k8s/ingress<span class="token comment"># kubectl get pods -n study-ingress </span>
NAME                           READY   STATUS    RESTARTS   AGE
payment-6db9544664-mw58v       <span class="token number">1</span>/1     Running   <span class="token number">0</span>          4s
user-6c76495bf9-8qw9d          <span class="token number">1</span>/1     Running   <span class="token number">0</span>          15s<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>


<p>配置service</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">root@VM-26-130-ubuntu:/usr/local/src/k8s/ingress<span class="token comment"># kubectl expose deployment  -n study-ingress  user --port 8080</span>
service/user exposed
root@VM-26-130-ubuntu:/usr/local/src/k8s/ingress<span class="token comment"># kubectl expose deployment  -n study-ingress  payment --port 8080</span>
service/payment exposed<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<p>配置ingress</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">root@VM-26-130-ubuntu:/usr/local/src/k8s/ingress<span class="token comment"># cat user-payment-ingress.yaml </span>
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
 name: user-payment
 namespace: study-ingress
 annotations:
spec:
 ingressClassName: nginx
 rules:
 - host: project.test.com
   http:
     paths:
     - backend:
         service:
           name: user
           port:
             number: <span class="token number">8080</span>
       path: /user
       pathType: Prefix
     - backend:
         service:
           name: payment
           port:
             number: <span class="token number">8080</span>
       path: /payment
       pathType: Prefix<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>测试请求：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">root@VM-26-130-ubuntu:/usr/local/src/k8s/ingress<span class="token comment"># curl project.test.com/payment</span>
<span class="token punctuation">&#123;</span><span class="token string">"msg"</span><span class="token builtin class-name">:</span><span class="token string">"支付服务"</span>,<span class="token string">"商品名称"</span><span class="token builtin class-name">:</span><span class="token string">"未知商品"</span><span class="token punctuation">&#125;</span>
root@VM-26-130-ubuntu:/usr/local/src/k8s/ingress<span class="token comment"># curl -X POST project.test.com/user</span>
<span class="token punctuation">&#123;</span><span class="token string">"msg"</span><span class="token builtin class-name">:</span><span class="token string">"登录成功"</span>,<span class="token string">"用户名"</span><span class="token builtin class-name">:</span><span class="token string">"匿名用户"</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<p>此时访问是没有任何问题的，但是有可能程序提供的接口&#x2F;api 或者&#x2F;user，但是要求的接口并不是&#x2F;api 和&#x2F;user，比如要求的是 userapi 和 paymentapi，此时直接配置会报 404。</p>
<h6 id="2-3-12-2-404（Request-Entity-Too-Large）报错"><a href="#2-3-12-2-404（Request-Entity-Too-Large）报错" class="headerlink" title="2.3.12.2 404（Request Entity Too Large）报错"></a>2.3.12.2 404（Request Entity Too Large）报错</h6><p>有时候需要上传一些大文件给程序，但是 nginx 默认允许的最大文件大小只有 8M，不足以满足生产最大上传需求，此时可以通过 <code>nginx.ingress.kubernetes.io/proxy-body-size</code> 参数进行更改（也可以在 ConfigMap 中全局添加）：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">apiVersion: networking.k8s.io/v1 <span class="token comment"># k8s >= 1.22 必须 v1</span>
kind: Ingress
metadata:
 name: nginx-ingress
 namespace: study-ingress
 annotations:
   nginx.ingress.kubernetes.io/proxy-body-size: 32m
spec:
 ingressClassName: nginx <span class="token comment"># 指定该 Ingress 被哪个 Controller 解析</span>
 rules: <span class="token comment"># 定义路由匹配规则，可以配置多个</span>
 - host: dujie.test.com <span class="token comment"># 定义域名</span>
   http: <span class="token comment"># </span>
     paths: <span class="token comment"># 详细的路由配置，可以配置多个</span>
     - backend: <span class="token comment"># 指定该路由的后端</span>
         service:
           name: nginx
           port:
             number: <span class="token number">80</span>
       path: / <span class="token comment"># 指定 PATH</span>
       pathType: ImplementationSpecific <span class="token comment"># 指定匹配规则</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h6 id="2-3-12-3-503（Service-Unavaiable）报错"><a href="#2-3-12-3-503（Service-Unavaiable）报错" class="headerlink" title="2.3.12.3 503（Service Unavaiable）报错"></a>2.3.12.3 503（Service Unavaiable）报错</h6><p>503 一般是代理的服务不可用导致的，通常问题如下：</p>
<p>1. Ingress 代理配置错误，比如 Service 名字或端口写错</p>
<p>2. Ingress 代理的 Service 不存在</p>
<p>3. Ingress 代理的 Service 后端 Pod 不正常</p>
<h6 id="2-3-12-4-504（Gateway-Timeout）报错"><a href="#2-3-12-4-504（Gateway-Timeout）报错" class="headerlink" title="2.3.12.4 504（Gateway Timeout）报错"></a>2.3.12.4 504（Gateway Timeout）报错</h6><p>504 一般是代理的服务处理请求的时间过长，导致 Nginx 等待超时，此时需要确认服务的处理时长，或者查看服务是否有问题。</p>
<p>部署后端程序模拟报错：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">root@VM-26-130-ubuntu:/usr/local/src/k8s/ingress<span class="token comment">#  kubectl create deploy ingress-err --image=registry.cn-beijing.aliyuncs.com/dotbalo/ingress-err:v1 -n study-ingress</span>
deployment.apps/ingress-err created
root@VM-26-130-ubuntu:/usr/local/src/k8s/ingress<span class="token comment"># </span>
root@VM-26-130-ubuntu:/usr/local/src/k8s/ingress<span class="token comment">#  kubectl expose deploy ingress-err --port 8080 -n study-ingress</span>
service/ingress-err exposed

root@VM-26-130-ubuntu:/usr/local/src/k8s/ingress<span class="token comment"># kubectl get svc -n study-ingress</span>
NAME          TYPE        CLUSTER-IP      EXTERNAL-IP   PORT<span class="token punctuation">(</span>S<span class="token punctuation">)</span>    AGE
ingress-err   ClusterIP   <span class="token number">10.16</span>.231.176   <span class="token operator">&lt;</span>none<span class="token operator">></span>        <span class="token number">8080</span>/TCP   6s<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>请求接口，返回时间比较长：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">root@VM-26-130-ubuntu:/usr/local/src/k8s/ingress<span class="token comment"># curl 10.16.231.176:8080/longtime</span>
<span class="token punctuation">&#123;</span><span class="token string">"msg"</span><span class="token builtin class-name">:</span><span class="token string">"任务处理成功"</span>,<span class="token string">"处理时间"</span>:45<span class="token punctuation">&#125;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p>配置ingress</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">root@VM-26-130-ubuntu:/usr/local/src/k8s/ingress<span class="token comment"># cat longtime-ingress.yaml </span>
apiVersion: networking.k8s.io/v1 <span class="token comment"># k8s >= 1.22 必须 v1</span>
kind: Ingress
metadata:
 name: longtime
 namespace: study-ingress
 annotations:
spec:
 ingressClassName: nginx <span class="token comment"># 指定该 Ingress 被哪个 Controller 解析</span>
 rules: <span class="token comment"># 定义路由匹配规则，可以配置多个</span>
 - host: longtime.test.com <span class="token comment"># 定义域名</span>
   http: <span class="token comment"># </span>
     paths: <span class="token comment"># 详细的路由配置，可以配置多个</span>
     - backend: <span class="token comment"># 指定该路由的后端</span>
         service:
           name: ingress-err
           port:
             number: <span class="token number">8080</span>
       path: / <span class="token comment"># 指定 PATH</span>
       pathType: ImplementationSpecific <span class="token comment"># 指定匹配规则</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>测试访问</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># curl http://longtime.test.com/longtime</span>
<span class="token operator">&lt;</span>html<span class="token operator">></span>
<span class="token operator">&lt;</span>head<span class="token operator">></span><span class="token operator">&lt;</span>title<span class="token operator">></span><span class="token number">504</span> Gateway Time-out<span class="token operator">&lt;</span>/title<span class="token operator">></span><span class="token operator">&lt;</span>/head<span class="token operator">></span>
<span class="token operator">&lt;</span>body<span class="token operator">></span>
<span class="token operator">&lt;</span>center<span class="token operator">></span><span class="token operator">&lt;</span>h<span class="token operator"><span class="token file-descriptor important">1</span>></span><span class="token number">504</span> Gateway Time-out<span class="token operator">&lt;</span>/h<span class="token operator"><span class="token file-descriptor important">1</span>></span><span class="token operator">&lt;</span>/center<span class="token operator">></span>
<span class="token operator">&lt;</span>hr<span class="token operator">></span><span class="token operator">&lt;</span>center<span class="token operator">></span>nginx<span class="token operator">&lt;</span>/center<span class="token operator">></span>
<span class="token operator">&lt;</span>/body<span class="token operator">></span>
<span class="token operator">&lt;</span>/html<span class="token operator">></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>配置合适的超时时间：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">root@VM-26-130-ubuntu:/usr/local/src/k8s/ingress<span class="token comment"># cat longtime-ingress.yaml </span>
apiVersion: networking.k8s.io/v1 <span class="token comment"># k8s >= 1.22 必须 v1</span>
kind: Ingress
metadata:
 name: longtime
 namespace: study-ingress
 annotations:
   nginx.ingress.kubernetes.io/proxy-connect-timeout: <span class="token string">"120"</span>
   nginx.ingress.kubernetes.io/proxy-send-timeout: <span class="token string">"120"</span>
   nginx.ingress.kubernetes.io/proxy-read-timeout: <span class="token string">"120"</span>
spec:
 ingressClassName: nginx <span class="token comment"># 指定该 Ingress 被哪个 Controller 解析</span>
 rules: <span class="token comment"># 定义路由匹配规则，可以配置多个</span>
 - host: longtime.test.com <span class="token comment"># 定义域名</span>
   http: <span class="token comment"># </span>
     paths: <span class="token comment"># 详细的路由配置，可以配置多个</span>
     - backend: <span class="token comment"># 指定该路由的后端</span>
         service:
           name: ingress-err
           port:
             number: <span class="token number">8080</span>
       path: / <span class="token comment"># 指定 PATH</span>
       pathType: ImplementationSpecific <span class="token comment"># 指定匹配规则</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h6 id="2-3-12-5-CORS跨域报错"><a href="#2-3-12-5-CORS跨域报错" class="headerlink" title="2.3.12.5  CORS跨域报错"></a>2.3.12.5  CORS跨域报错</h6><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">root@VM-26-130-ubuntu:/usr/local/src/k8s/ingress<span class="token comment"># cat cors-ingress.yaml </span>
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
 name: longtime
 namespace: study-ingress
 annotations:
   nginx.ingress.kubernetes.io/enable-cors: <span class="token string">"true"</span>
 <span class="token comment"># 允许跨域的请求方法</span>
   nginx.ingress.kubernetes.io/cors-allow-methods: <span class="token string">"PUT, GET, POST, OPTIONS, DELETE"</span>
 <span class="token comment"># 允许携带的请求头</span>
   nginx.ingress.kubernetes.io/cors-allow-headers: <span class="token string">"X-Forwarded-For,X-app123-XPTO"</span>
 <span class="token comment"># 允许跨域的域名</span>
   nginx.ingress.kubernetes.io/cors-allow-origin: <span class="token string">"*"</span>
spec:
 ingressClassName: nginx
 rules:
 - host: longtime.test.com
   http:
     paths:
     - backend:
         service:
           name: ingress-err
           port:
             number: <span class="token number">8080</span>
       path: /
       pathType: Prefix<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>










</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="http://dycloud.fun">J.</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接: </span><span class="post-copyright-info"><a href="http://dycloud.fun/2022/08/17/Ingress%E4%BD%BF%E7%94%A8%E5%8F%8A%E7%94%9F%E4%BA%A7%E6%A1%88%E4%BE%8B/">http://dycloud.fun/2022/08/17/Ingress%E4%BD%BF%E7%94%A8%E5%8F%8A%E7%94%9F%E4%BA%A7%E6%A1%88%E4%BE%8B/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="http://dycloud.fun" target="_blank">J.のblog</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/kubernetes/">kubernetes</a><a class="post-meta__tags" href="/tags/%E4%BA%91%E5%8E%9F%E7%94%9F/">云原生</a></div><div class="post_share"><div class="addthis_inline_share_toolbox"></div><script src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-5d034d84b42927bf" async="async"></script></div></div><div class="post-reward"><div class="reward-button"><i class="fas fa-qrcode"></i> 打赏</div><div class="reward-main"><ul class="reward-all"><li class="reward-item"><a href="/img/wechat.jpg" target="_blank"><img class="post-qr-code-img" src="/img/wechat.jpg" alt="微信"/></a><div class="post-qr-code-desc">微信</div></li><li class="reward-item"><a href="/img/alipay.jpg" target="_blank"><img class="post-qr-code-img" src="/img/alipay.jpg" alt="支付宝"/></a><div class="post-qr-code-desc">支付宝</div></li></ul></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/2022/08/19/kubernetes%E7%A3%81%E7%9B%98%E7%88%86%E6%BB%A1%E6%95%85%E9%9A%9C%E5%A4%84%E7%90%86/"><img class="prev-cover" src="/img/kubernetes.png" onerror="onerror=null;src='/img/404.jpg'" alt="cover of previous post"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">kubernetes 磁盘爆满故障处理</div></div></a></div><div class="next-post pull-right"><a href="/2022/08/17/%E6%B1%A1%E7%82%B9%E3%80%81%E5%AE%B9%E5%BF%8D%E7%94%9F%E4%BA%A7%E6%A1%88%E4%BE%8B/"><img class="next-cover" src="/img/kubernetes.png" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">污点及容忍生产案例</div></div></a></div></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span>相关推荐</span></div><div class="relatedPosts-list"><div><a href="/2022/07/02/Configmap/" title="kubernetes常用资源——configMap"><img class="cover" src="/img/kubernetes.png" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2022-07-02</div><div class="title">kubernetes常用资源——configMap</div></div></a></div><div><a href="/2022/07/01/Deployment%E5%89%AF%E6%9C%AC%E6%8E%A7%E5%88%B6%E5%99%A8/" title="kubernetes常用资源——deployment"><img class="cover" src="/img/kubernetes.png" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2022-07-01</div><div class="title">kubernetes常用资源——deployment</div></div></a></div><div><a href="/2022/07/02/PV%20PVC/" title="kubernetes常用资源——PV&#x2F;PVC"><img class="cover" src="/img/kubernetes.png" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2022-07-02</div><div class="title">kubernetes常用资源——PV&#x2F;PVC</div></div></a></div><div><a href="/2022/08/15/Pod%E5%BC%82%E5%B8%B8%E7%8A%B6%E6%80%81%E6%8E%92%E9%94%99/" title="Pod异常状态排错"><img class="cover" src="/img/kubernetes.png" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2022-08-15</div><div class="title">Pod异常状态排错</div></div></a></div><div><a href="/2022/07/01/RC%20RS%E5%89%AF%E6%9C%AC%E6%8E%A7%E5%88%B6%E5%99%A8/" title="kubernetes常用资源——RC&#x2F;RS"><img class="cover" src="/img/kubernetes.png" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2022-07-01</div><div class="title">kubernetes常用资源——RC&#x2F;RS</div></div></a></div><div><a href="/2022/07/03/Volume%E5%AD%98%E5%82%A8%E5%8D%B7/" title="kubernetes常用资源——Volume存储卷"><img class="cover" src="/img/kubernetes.png" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2022-07-03</div><div class="title">kubernetes常用资源——Volume存储卷</div></div></a></div></div></div><hr/><div id="post-comment"><div class="comment-head"><div class="comment-headline"><i class="fas fa-comments fa-fw"></i><span> 评论</span></div></div><div class="comment-wrap"><div><div id="lv-container" data-id="city" data-uid="MTAyMC81Njk5OS8zMzQ2Mw=="></div></div></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="is-center"><div class="avatar-img"><img src="/img/touxiang.png" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info__name">J.</div><div class="author-info__description"></div></div><div class="card-info-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">137</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">20</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">14</div></a></div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#ingress"><span class="toc-number">1.</span> <span class="toc-text">ingress</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%B8%80%E3%80%81ingress%E6%9E%B6%E6%9E%84"><span class="toc-number">1.0.1.</span> <span class="toc-text">一、ingress架构</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#1-%E5%A4%96%E9%83%A8%E6%8E%A5%E5%85%A5%E5%B1%82%EF%BC%88Internet-x2F-DMZ%EF%BC%89"><span class="toc-number">1.0.1.0.0.1.</span> <span class="toc-text">1. 外部接入层（Internet&#x2F;DMZ）</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#2-%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1%E5%B1%82%EF%BC%88%E9%AB%98%E5%8F%AF%E7%94%A8%E8%AE%BE%E8%AE%A1%EF%BC%89"><span class="toc-number">1.0.1.0.0.2.</span> <span class="toc-text">2. 负载均衡层（高可用设计）</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#3-Ingress%E6%8E%A7%E5%88%B6%E5%B1%82%EF%BC%88Kubernetes%E8%8A%82%E7%82%B9%EF%BC%89"><span class="toc-number">1.0.1.0.0.3.</span> <span class="toc-text">3. Ingress控制层（Kubernetes节点）</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#4-%E5%90%8E%E7%AB%AF%E6%9C%8D%E5%8A%A1%E5%B1%82%EF%BC%88Real-Server%EF%BC%89"><span class="toc-number">1.0.1.0.0.4.</span> <span class="toc-text">4. 后端服务层（Real Server）</span></a></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BA%8C%E3%80%81ingress%E4%BD%BF%E7%94%A8"><span class="toc-number">1.0.2.</span> <span class="toc-text">二、ingress使用</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#2-1-%E8%B5%84%E6%BA%90%E5%AE%9A%E4%B9%89"><span class="toc-number">1.0.2.0.1.</span> <span class="toc-text">2.1 资源定义</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#2-2-Ingress%E5%85%A5%E9%97%A8"><span class="toc-number">1.0.2.0.2.</span> <span class="toc-text">2.2 Ingress入门</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#2-2-1-%E4%BD%BF%E7%94%A8%E5%9F%9F%E5%90%8D%E5%8F%91%E5%B8%83K8S%E6%9C%8D%E5%8A%A1"><span class="toc-number">1.0.2.0.2.1.</span> <span class="toc-text">2.2.1 使用域名发布K8S服务</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#2-2-2-Ingress%E7%89%B9%E4%BE%8B%EF%BC%9A%E4%B8%8D%E9%85%8D%E7%BD%AE%E5%9F%9F%E5%90%8D%E5%8F%91%E5%B8%83%E6%9C%8D%E5%8A%A1"><span class="toc-number">1.0.2.0.2.2.</span> <span class="toc-text">2.2.2 Ingress特例：不配置域名发布服务</span></a></li></ol></li><li class="toc-item toc-level-5"><a class="toc-link" href="#2-3-Ingress%E5%AE%9E%E6%88%98"><span class="toc-number">1.0.2.0.3.</span> <span class="toc-text">2.3 Ingress实战</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#2-3-1-%E4%BD%BF%E7%94%A8HTTPS%E5%8F%91%E5%B8%83%E6%9C%8D%E5%8A%A1"><span class="toc-number">1.0.2.0.3.1.</span> <span class="toc-text">2.3.1 使用HTTPS发布服务</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#2-3-2-%E5%9F%9F%E5%90%8D%E6%B7%BB%E5%8A%A0%E7%94%A8%E6%88%B7%E5%90%8D%E5%AF%86%E7%A0%81%E8%AE%A4%E8%AF%81"><span class="toc-number">1.0.2.0.3.2.</span> <span class="toc-text">2.3.2 域名添加用户名密码认证</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#2-3-3-%E5%BC%80%E5%90%AF%E4%BC%9A%E8%AF%9D%E4%BF%9D%E6%8C%81"><span class="toc-number">1.0.2.0.3.3.</span> <span class="toc-text">2.3.3 开启会话保持</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#2-3-4-%E9%85%8D%E7%BD%AE%E6%B5%81%E5%BC%8F%E8%BF%94%E5%9B%9ESSE%EF%BC%88%E4%BB%A3%E7%90%86%E5%A4%A7%E6%A8%A1%E5%9E%8B%E6%9C%8D%E5%8A%A1%EF%BC%89"><span class="toc-number">1.0.2.0.3.4.</span> <span class="toc-text">2.3.4 配置流式返回SSE（代理大模型服务）</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#2-3-5-%E5%9F%9F%E5%90%8D%E9%87%8D%E5%AE%9A%E5%90%91Redirect"><span class="toc-number">1.0.2.0.3.5.</span> <span class="toc-text">2.3.5 域名重定向Redirect</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#2-3-6-%E8%AE%BF%E9%97%AE%E5%9C%B0%E5%9D%80%E9%87%8D%E5%86%99Rewrite"><span class="toc-number">1.0.2.0.3.6.</span> <span class="toc-text">2.3.6 访问地址重写Rewrite</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#2-3-7-%E8%AE%BF%E9%97%AE%E9%80%9F%E7%8E%87%E9%99%90%E5%88%B6"><span class="toc-number">1.0.2.0.3.7.</span> <span class="toc-text">2.3.7 访问速率限制</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#2-3-8-IngressNginx-%E9%BB%91-x2F-%E7%99%BD%E5%90%8D%E5%8D%95"><span class="toc-number">1.0.2.0.3.8.</span> <span class="toc-text">2.3.8 IngressNginx 黑&#x2F;白名单</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#2-3-9-%E8%87%AA%E5%AE%9A%E4%B9%89%E9%94%99%E8%AF%AF%E9%A1%B5"><span class="toc-number">1.0.2.0.3.9.</span> <span class="toc-text">2.3.9 自定义错误页</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#2-3-10-%E5%8C%B9%E9%85%8D%E8%AF%B7%E6%B1%82%E5%A4%B4%E5%8C%BA%E5%88%86%E4%B8%8D%E5%90%8C%E5%AE%A2%E6%88%B7%E7%AB%AF"><span class="toc-number">1.0.2.0.3.10.</span> <span class="toc-text">2.3.10 匹配请求头区分不同客户端</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#2-3-11-%E7%81%B0%E5%BA%A6-x2F-%E9%87%91%E4%B8%9D%E9%9B%80-x2F-%E8%93%9D%E7%BB%BF%E5%8F%91%E5%B8%83"><span class="toc-number">1.0.2.0.3.11.</span> <span class="toc-text">2.3.11 灰度&#x2F;金丝雀&#x2F;蓝绿发布</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#2-3-12-Ingress%E5%B8%B8%E8%A7%81%E6%8A%A5%E9%94%99%E6%8E%92%E6%9F%A5"><span class="toc-number">1.0.2.0.3.12.</span> <span class="toc-text">2.3.12 Ingress常见报错排查</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#2-3-12-1-404%EF%BC%88Not-Found%EF%BC%89%E6%8A%A5%E9%94%99"><span class="toc-number">1.0.2.0.3.13.</span> <span class="toc-text">2.3.12.1 404（Not Found）报错</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#2-3-12-2-404%EF%BC%88Request-Entity-Too-Large%EF%BC%89%E6%8A%A5%E9%94%99"><span class="toc-number">1.0.2.0.3.14.</span> <span class="toc-text">2.3.12.2 404（Request Entity Too Large）报错</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#2-3-12-3-503%EF%BC%88Service-Unavaiable%EF%BC%89%E6%8A%A5%E9%94%99"><span class="toc-number">1.0.2.0.3.15.</span> <span class="toc-text">2.3.12.3 503（Service Unavaiable）报错</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#2-3-12-4-504%EF%BC%88Gateway-Timeout%EF%BC%89%E6%8A%A5%E9%94%99"><span class="toc-number">1.0.2.0.3.16.</span> <span class="toc-text">2.3.12.4 504（Gateway Timeout）报错</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#2-3-12-5-CORS%E8%B7%A8%E5%9F%9F%E6%8A%A5%E9%94%99"><span class="toc-number">1.0.2.0.3.17.</span> <span class="toc-text">2.3.12.5  CORS跨域报错</span></a></li></ol></li></ol></li></ol></li></ol></li></ol></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>最新文章</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/2024/07/24/%E8%B0%83%E7%94%A8k8s%20api%E5%AE%9E%E7%8E%B0%E6%B7%BB%E5%8A%A0%E7%94%A8%E6%88%B7%E5%B9%B6%E6%8E%88%E6%9D%83/" title="调用k8s API实现添加用户并授权"><img src="/img/kubernetes.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="调用k8s API实现添加用户并授权"/></a><div class="content"><a class="title" href="/2024/07/24/%E8%B0%83%E7%94%A8k8s%20api%E5%AE%9E%E7%8E%B0%E6%B7%BB%E5%8A%A0%E7%94%A8%E6%88%B7%E5%B9%B6%E6%8E%88%E6%9D%83/" title="调用k8s API实现添加用户并授权">调用k8s API实现添加用户并授权</a><time datetime="2024-07-24T12:32:00.000Z" title="发表于 2024-07-24 20:32:00">2024-07-24</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2024/05/26/prometheus%20operator/" title="prometheus operator"><img src="/img/prometheus.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="prometheus operator"/></a><div class="content"><a class="title" href="/2024/05/26/prometheus%20operator/" title="prometheus operator">prometheus operator</a><time datetime="2024-05-26T07:51:23.000Z" title="发表于 2024-05-26 15:51:23">2024-05-26</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2024/05/23/%E4%BD%BF%E7%94%A8rook-ceph%E9%83%A8%E7%BD%B2%E9%AB%98%E5%8F%AF%E7%94%A8ceph%E9%9B%86%E7%BE%A4/" title="使用rook-ceph部署高可用ceph集群"><img src="/img/ceph.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="使用rook-ceph部署高可用ceph集群"/></a><div class="content"><a class="title" href="/2024/05/23/%E4%BD%BF%E7%94%A8rook-ceph%E9%83%A8%E7%BD%B2%E9%AB%98%E5%8F%AF%E7%94%A8ceph%E9%9B%86%E7%BE%A4/" title="使用rook-ceph部署高可用ceph集群">使用rook-ceph部署高可用ceph集群</a><time datetime="2024-05-23T07:51:23.000Z" title="发表于 2024-05-23 15:51:23">2024-05-23</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2024/03/12/%E8%AE%B0%E5%BD%95AWS%20Oracle%E5%AE%9E%E4%BE%8B%E6%95%B0%E6%8D%AE%E8%BF%81%E7%A7%BB%E7%9A%84%E8%89%B0%E8%BE%9B%E8%BF%87%E7%A8%8B/" title="记录AWS Oracle实例数据迁移的艰辛过程"><img src="/img/oracle.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="记录AWS Oracle实例数据迁移的艰辛过程"/></a><div class="content"><a class="title" href="/2024/03/12/%E8%AE%B0%E5%BD%95AWS%20Oracle%E5%AE%9E%E4%BE%8B%E6%95%B0%E6%8D%AE%E8%BF%81%E7%A7%BB%E7%9A%84%E8%89%B0%E8%BE%9B%E8%BF%87%E7%A8%8B/" title="记录AWS Oracle实例数据迁移的艰辛过程">记录AWS Oracle实例数据迁移的艰辛过程</a><time datetime="2024-03-12T04:12:23.000Z" title="发表于 2024-03-12 12:12:23">2024-03-12</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2024/02/25/kubernetes%20platform%E5%90%8E%E7%AB%AF%E5%BC%80%E5%8F%91-cluster%E7%9B%B8%E5%85%B3%E7%BB%84%E4%BB%B6/" title="kubernetes platform后端开发-cluster相关组件"><img src="/img/kubernetes.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="kubernetes platform后端开发-cluster相关组件"/></a><div class="content"><a class="title" href="/2024/02/25/kubernetes%20platform%E5%90%8E%E7%AB%AF%E5%BC%80%E5%8F%91-cluster%E7%9B%B8%E5%85%B3%E7%BB%84%E4%BB%B6/" title="kubernetes platform后端开发-cluster相关组件">kubernetes platform后端开发-cluster相关组件</a><time datetime="2024-02-25T06:32:00.000Z" title="发表于 2024-02-25 14:32:00">2024-02-25</time></div></div></div></div></div></div></main><footer id="footer" style="background-image: url('/img/longzhu.png')"><div id="footer-wrap"><div class="copyright">&copy;2019 - 2025  <i id="heartbeat" class="fa fas fa-heartbeat"></i> J.</div><div class="framework-info"><span>框架 </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>主题 </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a><a href="http://beian.miit.gov.cn/"  style="color:#f72b07" target="_blank">京ICP备2022023567号</a></div></div><link rel="stylesheet" href="https://fastly.jsdelivr.net/gh/HCLonely/images@master/others/heartbeat.min.css"></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="translateLink" type="button" title="简繁转换">繁</button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><a id="to_comment" href="#post-comment" title="直达评论"><i class="fas fa-comments"></i></a><button id="go-up" type="button" title="回到顶部"><i class="fas fa-arrow-up"></i></button></div></div><div id="algolia-search"><div class="search-dialog"><nav class="search-nav"><span class="search-dialog-title">搜索</span><button class="search-close-button"><i class="fas fa-times"></i></button></nav><div class="search-wrap"><div id="algolia-search-input"></div><hr/><div id="algolia-search-results"><div id="algolia-hits"></div><div id="algolia-pagination"></div><div id="algolia-info"><div class="algolia-stats"></div><div class="algolia-poweredBy"></div></div></div></div></div><div id="search-mask"></div></div><div id="rightMenu"><div class="rightMenu-group rightMenu-small"><div class="rightMenu-item" id="menu-backward"><i class="fa-solid fa-arrow-left"></i></div><div class="rightMenu-item" id="menu-forward"><i class="fa-solid fa-arrow-right"></i></div><div class="rightMenu-item" id="menu-refresh"><i class="fa-solid fa-arrow-rotate-right"></i></div><div class="rightMenu-item" id="menu-home"><i class="fa-solid fa-house"></i></div></div><div class="rightMenu-group rightMenu-line rightMenuOther"><a class="rightMenu-item menu-link" href="/archives/"><i class="fa-solid fa-archive"></i><span>文章归档</span></a><a class="rightMenu-item menu-link" href="/categories/"><i class="fa-solid fa-folder-open"></i><span>文章分类</span></a><a class="rightMenu-item menu-link" href="/tags/"><i class="fa-solid fa-tags"></i><span>文章标签</span></a></div><div class="rightMenu-group rightMenu-line rightMenuNormal"><a class="rightMenu-item menu-link" id="menu-radompage" href="/random/index.html"><i class="fa-solid fa-shoe-prints"></i><span>随便逛逛</span></a><div class="rightMenu-item" id="menu-translate"><i class="fa-solid fa-earth-asia"></i><span>繁简切换</span></div><div class="rightMenu-item" id="menu-darkmode"><i class="fa-solid fa-moon"></i><span>切换模式</span></div></div></div><div id="rightmenu-mask"></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="/js/tw_cn.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox.umd.min.js"></script><script src="https://cdn.jsdelivr.net/npm/algoliasearch/dist/algoliasearch-lite.umd.min.js"></script><script src="https://cdn.jsdelivr.net/npm/instantsearch.js/dist/instantsearch.production.min.js"></script><script src="/js/search/algolia.js"></script><script>var preloader = {
  endLoading: () => {
    document.body.style.overflow = 'auto';
    document.getElementById('loading-box').classList.add("loaded")
  },
  initLoading: () => {
    document.body.style.overflow = '';
    document.getElementById('loading-box').classList.remove("loaded")

  }
}
window.addEventListener('load',preloader.endLoading())</script><div class="js-pjax"><script>function loadLivere () {
  if (typeof LivereTower === 'object') {
    window.LivereTower.init()
  }
  else {
    (function(d, s) {
        var j, e = d.getElementsByTagName(s)[0];
        if (typeof LivereTower === 'function') { return; }
        j = d.createElement(s);
        j.src = 'https://cdn-city.livere.com/js/embed.dist.js';
        j.async = true;
        e.parentNode.insertBefore(j, e);
    })(document, 'script');
  }
}

if ('Livere' === 'Livere' || !false) {
  if (false) btf.loadComment(document.getElementById('lv-container'), loadLivere)
  else loadLivere()
}
else {
  function loadOtherComment () {
    loadLivere()
  }
}</script></div><script defer src="https://npm.elemecdn.com/jquery@latest/dist/jquery.min.js"></script><script data-pjax defer src="https://npm.elemecdn.com/tzy-blog/lib/js/theme/chocolate.js"></script><canvas id="universe"></canvas><script defer src="/js/universe.js"></script><script defer data-pjax src="/js/rightMenu.js"></script><div class="aplayer no-destroy" data-id="7427714271" data-server="netease" data-type="playlist" data-fixed="true" data-mini="true" data-listFolded="false" data-order="random" data-lrctype="1" data-preload="none" data-autoplay="true" muted></div><script id="click-show-text" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/dist/click-show-text.min.js" data-mobile="false" data-text="I,LOVE,YOU" data-fontsize="15px" data-random="false" async="async"></script><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/aplayer/dist/APlayer.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/aplayer/dist/APlayer.min.js"></script><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/metingjs/dist/Meting.min.js"></script><script src="https://cdn.jsdelivr.net/npm/pjax/pjax.min.js"></script><script>let pjaxSelectors = ["meta[property=\"og:image\"]","meta[property=\"og:title\"]","meta[property=\"og:url\"]","head > title","#config-diff","#body-wrap","#rightside-config-hide","#rightside-config-show",".js-pjax"]

var pjax = new Pjax({
  elements: 'a:not([target="_blank"])',
  selectors: pjaxSelectors,
  cacheBust: false,
  analytics: false,
  scrollRestoration: false
})

document.addEventListener('pjax:send', function () {

  // removeEventListener scroll 
  window.tocScrollFn && window.removeEventListener('scroll', window.tocScrollFn)
  window.scrollCollect && window.removeEventListener('scroll', scrollCollect)

  typeof preloader === 'object' && preloader.initLoading()
  document.getElementById('rightside').style.cssText = "opacity: ''; transform: ''"
  
  if (window.aplayers) {
    for (let i = 0; i < window.aplayers.length; i++) {
      if (!window.aplayers[i].options.fixed) {
        window.aplayers[i].destroy()
      }
    }
  }

  typeof typed === 'object' && typed.destroy()

  //reset readmode
  const $bodyClassList = document.body.classList
  $bodyClassList.contains('read-mode') && $bodyClassList.remove('read-mode')

  typeof disqusjs === 'object' && disqusjs.destroy()
})

document.addEventListener('pjax:complete', function () {
  window.refreshFn()

  document.querySelectorAll('script[data-pjax]').forEach(item => {
    const newScript = document.createElement('script')
    const content = item.text || item.textContent || item.innerHTML || ""
    Array.from(item.attributes).forEach(attr => newScript.setAttribute(attr.name, attr.value))
    newScript.appendChild(document.createTextNode(content))
    item.parentNode.replaceChild(newScript, item)
  })

  GLOBAL_CONFIG.islazyload && window.lazyLoadInstance.update()

  typeof chatBtnFn === 'function' && chatBtnFn()
  typeof panguInit === 'function' && panguInit()

  // google analytics
  typeof gtag === 'function' && gtag('config', '', {'page_path': window.location.pathname});

  // baidu analytics
  typeof _hmt === 'object' && _hmt.push(['_trackPageview',window.location.pathname]);

  typeof loadMeting === 'function' && document.getElementsByClassName('aplayer').length && loadMeting()

  // prismjs
  typeof Prism === 'object' && Prism.highlightAll()

  typeof preloader === 'object' && preloader.endLoading()
})

document.addEventListener('pjax:error', (e) => {
  if (e.request.status === 404) {
    pjax.loadUrl('/404.html')
  }
})</script><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div><!-- hexo injector body_end start --><script data-pjax>
  function butterfly_clock_anzhiyu_injector_config(){
    var parent_div_git = document.getElementsByClassName('sticky_layout')[0];
    var item_html = '<div class="card-widget card-clock"><div class="card-glass"><div class="card-background"><div class="card-content"><div id="hexo_electric_clock"><img class="entered loading" id="card-clock-loading" src="https://cdn.cbd.int/hexo-butterfly-clock-anzhiyu/lib/loading.gif" style="height: 120px; width: 100%;" data-ll-status="loading"/></div></div></div></div></div>';
    console.log('已挂载butterfly_clock_anzhiyu')
    if(parent_div_git) {
      parent_div_git.insertAdjacentHTML("afterbegin",item_html)
    }
  }
  var elist = 'null'.split(',');
  var cpage = location.pathname;
  var epage = 'all';
  var qweather_key = '56289903f0d448dfbe8262dba0175f70';
  var gaud_map_key = '01603f2b2d08d0e947bb101e9d9b148b';
  var baidu_ak_key = 'undefined';
  var flag = 0;
  var clock_rectangle = '112.982279,28.19409';
  var clock_default_rectangle_enable = 'false';

  for (var i=0;i<elist.length;i++){
    if (cpage.includes(elist[i])){
      flag++;
    }
  }

  if ((epage ==='all')&&(flag == 0)){
    butterfly_clock_anzhiyu_injector_config();
  }
  else if (epage === cpage){
    butterfly_clock_anzhiyu_injector_config();
  }
  </script><script src="https://widget.qweather.net/simple/static/js/he-simple-common.js?v=2.0"></script><script data-pjax src="https://cdn.cbd.int/hexo-butterfly-clock-anzhiyu/lib/clock.min.js"></script><!-- hexo injector body_end end --><script src="/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({"tagMode":false,"debug":false,"model":{"jsonPath":"/live2dw/assets/tororo.model.json"},"display":{"position":"right","width":150,"height":350,"hOffset":20,"vOffset":-20},"mobile":{"show":false},"log":false,"pluginJsPath":"lib/","pluginModelPath":"assets/","pluginRootPath":"live2dw/"});</script><script async>window.onload=function(){var a=document.createElement('script'),b=document.getElementsByTagName('script')[0];a.type='text/javascript',a.async=!0,a.src='/sw-register.js?v='+Date.now(),b.parentNode.insertBefore(a,b)};</script></body></html>